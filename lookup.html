<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Safe Freight Program Lookup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 2rem;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #1c3d5a;
    }
    .lookup-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    @media (min-width: 768px) {
      .lookup-container {
        flex-direction: row;
        justify-content: center;
      }
    }
    .lookup-box {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .lookup-box input {
      width: 80%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: center;
    }
    .lookup-box input::placeholder {
      color: #aaa;
    }
    .lookup-box button {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background-color: #1c3d5a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    .lookup-box button:hover {
      background-color: #285a7f;
    }
    .result {
      margin-top: 1rem;
      text-align: left;
      padding: 1rem;
      border-radius: 8px;
      border-left: 5px solid #1c3d5a;
      font-size: 0.95rem;
      color: #1c3d5a;
      position: relative;
    }
    .result.active {
      background-color: #e6f7e6;
    }
    .result.expired, .result.non-compliant {
      background-color: #ffe6e6;
    }
    .result.warning {
      background-color: #fff8dc;
    }
    .result span.copyable {
      cursor: pointer;
      text-decoration: underline dotted;
    }
    .copied-msg {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 0.85rem;
      color: green;
      display: none;
    }
    .prefix-label {
      font-weight: bold;
      margin-right: 5px;
    }
    .input-group {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>
<body>
  <h1>Safe Freight Program Lookup</h1>
  <div class="lookup-container">
    <!-- Driver Lookup -->
    <div class="lookup-box">
      <h3>Driver Lookup</h3>
      <div class="input-group">
        <span class="prefix-label">SFPD-</span>
        <input type="text" id="driverInput" placeholder="e.g. 0071" onkeydown="if(event.key==='Enter'){lookupDriver()}" />
      </div>
      <button onclick="lookupDriver()">Search</button>
      <div id="driverResult" class="result"><span class="copied-msg" id="copiedDriver"></span></div>
    </div>

    <!-- Vehicle Lookup -->
    <div class="lookup-box">
      <h3>Vehicle Lookup</h3>
      <div class="input-group">
        <span class="prefix-label">SFPV-</span>
        <input type="text" id="vehicleInput" placeholder="e.g. 0143" onkeydown="if(event.key==='Enter'){lookupVehicle()}" />
      </div>
      <button onclick="lookupVehicle()">Search</button>
      <h4 style="margin-top:2rem;">...or search by Rego</h4>
      <input type="text" id="regoInput" placeholder="e.g. LMN435" onkeydown="if(event.key==='Enter'){lookupVehicleByRego()}" />
      <button onclick="lookupVehicleByRego()">Search by Rego</button>
      <div id="vehicleResult" class="result"><span class="copied-msg" id="copiedVehicle"></span></div>
    </div>
  </div>

  <script>
    const DRIVER_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ/gviz/tq?tqx=out:json';
    const VEHICLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1FrQaKHSrYAl3L10netuq-HOqRMOUdyFCekJjBtJNTP8/gviz/tq?tqx=out:json';

    async function fetchSheetData(url) {
      const response = await fetch(url);
      const text = await response.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      return json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ''));
    }

    function padWithZeros(input, length = 6) {
      return input.padStart(length, '0');
    }

    function formatDate(d) {
      if (!d) return '';
      
      let parsedDate;
      
      // Handle different date formats that Google Sheets might return
      if (typeof d === 'string') {
        // Try different date formats
        if (d.includes('/')) {
          // Handle formats like "12/31/2024" or "31/12/2024"
          const parts = d.split('/');
          if (parts.length === 3) {
            // Try MM/DD/YYYY format first
            parsedDate = new Date(parts[2], parts[0] - 1, parts[1]);
            if (isNaN(parsedDate.getTime())) {
              // Try DD/MM/YYYY format
              parsedDate = new Date(parts[2], parts[1] - 1, parts[0]);
            }
          }
        } else if (d.includes('-')) {
          // Handle formats like "2024-12-31" or "31-12-2024"
          const parts = d.split('-');
          if (parts.length === 3) {
            if (parts[0].length === 4) {
              // YYYY-MM-DD format
              parsedDate = new Date(parts[0], parts[1] - 1, parts[2]);
            } else {
              // DD-MM-YYYY format
              parsedDate = new Date(parts[2], parts[1] - 1, parts[0]);
            }
          }
        } else {
          // Try to parse as is
          parsedDate = new Date(d);
        }
      } else if (typeof d === 'number') {
        // Google Sheets sometimes returns dates as numbers (Excel serial dates)
        // Excel epoch starts on January 1, 1900, but JavaScript Date starts on January 1, 1970
        // Excel serial date 1 = January 1, 1900
        // Convert Excel serial date to JavaScript date
        parsedDate = new Date((d - 25569) * 86400 * 1000);
      } else if (Object.prototype.toString.call(d) === '[object Date]') {
        parsedDate = d;
      } else {
        return 'Invalid Date';
      }
      
      // Check if the parsed date is valid
      if (isNaN(parsedDate.getTime())) {
        console.log('Failed to parse date:', d);
        return 'Invalid Date';
      }
      
      return parsedDate.toLocaleDateString('en-AU', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
      });
    }

    function getStatusClass(status, expiryRaw) {
      const statusLC = status.toLowerCase();
      if (statusLC === 'expired' || statusLC === 'non-compliant') return 'non-compliant';
      
      const today = new Date();
      let expiryDate;
      
      // Parse the expiry date using the same logic as formatDate
      if (typeof expiryRaw === 'string') {
        if (expiryRaw.includes('/')) {
          const parts = expiryRaw.split('/');
          if (parts.length === 3) {
            expiryDate = new Date(parts[2], parts[0] - 1, parts[1]);
            if (isNaN(expiryDate.getTime())) {
              expiryDate = new Date(parts[2], parts[1] - 1, parts[0]);
            }
          }
        } else if (expiryRaw.includes('-')) {
          const parts = expiryRaw.split('-');
          if (parts.length === 3) {
            if (parts[0].length === 4) {
              expiryDate = new Date(parts[0], parts[1] - 1, parts[2]);
            } else {
              expiryDate = new Date(parts[2], parts[1] - 1, parts[0]);
            }
          }
        } else {
          expiryDate = new Date(expiryRaw);
        }
      } else if (typeof expiryRaw === 'number') {
        expiryDate = new Date((expiryRaw - 25569) * 86400 * 1000);
      } else {
        return 'active';
      }
      
      if (isNaN(expiryDate.getTime())) {
        return 'active';
      }
      
      const diffTime = expiryDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays <= 30 && diffDays >= 0) return 'warning';
      return 'active';
    }

    function makeCopyable(label, value, msgEl) {
      return `<strong>${label}</strong> <span class="copyable" onclick="copyWithMessage('${value}', '${msgEl}')">${value}</span><br>`;
    }

    function copyWithMessage(value, targetId) {
      navigator.clipboard.writeText(value);
      const msg = document.getElementById(targetId);
      if (msg) {
        msg.textContent = 'Copied!';
        msg.style.display = 'inline';
        setTimeout(() => msg.style.display = 'none', 1200);
      }
    }

    async function lookupDriver() {
      const raw = document.getElementById('driverInput').value.trim();
      const input = 'SFPD-' + padWithZeros(raw);
      const data = await fetchSheetData(DRIVER_SHEET_URL);
      const match = data.find(row => row[0] === input);
      const resultEl = document.getElementById('driverResult');
      if (match) {
        const statusClass = getStatusClass(match[3], match[4]);
        resultEl.className = 'result ' + statusClass;
        const warningNote = statusClass === 'warning' ? '<br><em>Note: Expiry within 30 days</em>' : '';
        resultEl.innerHTML = `
          ${makeCopyable('Name:', match[1] + ' ' + match[2], 'copiedDriver')}
          ${makeCopyable('SFP ID:', match[0], 'copiedDriver')}
          ${makeCopyable('Status:', match[3], 'copiedDriver')}
          ${makeCopyable('Expiry Date:', formatDate(match[4]), 'copiedDriver')}${warningNote}
        `;
      } else {
        resultEl.className = 'result';
        resultEl.textContent = 'Driver not found';
      }
    }

    async function lookupVehicle() {
      const raw = document.getElementById('vehicleInput').value.trim();
      const paddedInput = 'SFPV-' + padWithZeros(raw);
      const data = await fetchSheetData(VEHICLE_SHEET_URL);
      const match = data.find(row => row[0] === paddedInput);
      showVehicleResult(match);
    }

    async function lookupVehicleByRego() {
      const raw = document.getElementById('regoInput').value.trim().toUpperCase();
      const data = await fetchSheetData(VEHICLE_SHEET_URL);
      const match = data.find(row => row[2].toUpperCase() === raw);
      showVehicleResult(match);
    }

    function showVehicleResult(match) {
      const resultEl = document.getElementById('vehicleResult');
      if (match) {
        const statusClass = getStatusClass(match[4], match[5]);
        resultEl.className = 'result ' + statusClass;
        const warningNote = statusClass === 'warning' ? '<br><em>Note: Expiry within 30 days</em>' : '';
        resultEl.innerHTML = `
          ${makeCopyable('Type:', match[1], 'copiedVehicle')}
          ${makeCopyable('Plate:', match[2], 'copiedVehicle')}
          ${makeCopyable('VIN:', match[3], 'copiedVehicle')}
          ${makeCopyable('Status:', match[4], 'copiedVehicle')}
          ${makeCopyable('Expiry Date:', formatDate(match[5]), 'copiedVehicle')}${warningNote}
        `;
      } else {
        resultEl.className = 'result';
        resultEl.textContent = 'Vehicle not found';
      }
    }
  </script>
</body>
</html>
