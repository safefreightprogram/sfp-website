<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Safe Freight Program Lookup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 2rem;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #1c3d5a;
    }
    .lookup-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    @media (min-width: 768px) {
      .lookup-container {
        flex-direction: row;
        justify-content: center;
      }
    }
    .lookup-box {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .lookup-box input {
      width: 80%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: center;
    }
    .lookup-box input::placeholder {
      color: #aaa;
    }
    .lookup-box button {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background-color: #1c3d5a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    .lookup-box button:hover {
      background-color: #285a7f;
    }
    .result {
      margin-top: 1rem;
      text-align: left;
      padding: 1rem;
      border-radius: 8px;
      border-left: 5px solid #1c3d5a;
      font-size: 0.95rem;
      color: #1c3d5a;
    }
    .result.active {
      background-color: #e6f7e6;
    }
    .result.expired, .result.non-compliant {
      background-color: #ffe6e6;
    }
    .result.warning {
      background-color: #fff8dc;
    }
    .prefix-label {
      font-weight: bold;
      margin-right: 5px;
    }
    .input-group {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>
<body>
  <h1>Safe Freight Program Lookup</h1>
  <div class="lookup-container">
    <!-- Driver Lookup -->
    <div class="lookup-box">
      <h3>Driver Lookup</h3>
      <div class="input-group">
        <span class="prefix-label">SFPD-</span>
        <input type="text" id="driverInput" placeholder="e.g. 0071" onkeydown="if(event.key==='Enter'){lookupDriver()}">
      </div>
      <button onclick="lookupDriver()">Search</button>
      <div id="driverResult" class="result"></div>
    </div>

    <!-- Vehicle Lookup -->
    <div class="lookup-box">
      <h3>Vehicle Lookup</h3>
      <div class="input-group">
        <span class="prefix-label">SFPV-</span>
        <input type="text" id="vehicleInput" placeholder="e.g. 0143" onkeydown="if(event.key==='Enter'){lookupVehicle()}">
      </div>
      <button onclick="lookupVehicle()">Search</button>
      <div id="vehicleResult" class="result"></div>
    </div>
  </div>

  <script>
    const DRIVER_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ/gviz/tq?tqx=out:json';
    const VEHICLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1FrQaKHSrYAl3L10netuq-HOqRMOUdyFCekJjBtJNTP8/gviz/tq?tqx=out:json';

    async function fetchSheetData(url) {
      const response = await fetch(url);
      const text = await response.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      return json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ''));
    }

    function padWithZeros(input, length = 6) {
      return input.padStart(length, '0');
    }

    function formatDate(d) {
      if (!d) return '';
      if (Object.prototype.toString.call(d) === '[object Date]' && !isNaN(d)) {
        return d.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
      }

      let day, month, year;
      if (typeof d === 'string') {
        if (d.includes('/')) {
          [day, month, year] = d.split('/').map(n => parseInt(n, 10));
        } else if (d.includes('-')) {
          [year, month, day] = d.split('-').map(n => parseInt(n, 10));
        } else {
          return 'Invalid Date';
        }
        const parsed = new Date(year, month - 1, day);
        if (isNaN(parsed.getTime())) return 'Invalid Date';
        return parsed.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
      }

      const date = new Date(d);
      return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function getStatusClass(status, expiryRaw) {
      const statusLC = status.toLowerCase();
      if (statusLC === 'expired' || statusLC === 'non-compliant') return 'non-compliant';
      const today = new Date();
      let day, month, year;
      if (expiryRaw.includes('/')) {
        [day, month, year] = expiryRaw.split('/').map(n => parseInt(n, 10));
      } else {
        [year, month, day] = expiryRaw.split('-').map(n => parseInt(n, 10));
      }
      const expiryDate = new Date(year, month - 1, day);
      const diffTime = expiryDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      if (diffDays <= 30 && diffDays >= 0) return 'warning';
      return 'active';
    }

    async function lookupDriver() {
      const raw = document.getElementById('driverInput').value.trim();
      const input = 'SFPD-' + padWithZeros(raw);
      const data = await fetchSheetData(DRIVER_SHEET_URL);
      const match = data.find(row => row[0] === input);
      const resultEl = document.getElementById('driverResult');
      if (match) {
        const statusClass = getStatusClass(match[3], match[4]);
        resultEl.className = 'result ' + statusClass;
        const warningNote = statusClass === 'warning' ? '<br><em>Note: Expiry within 30 days</em>' : '';
        resultEl.innerHTML = `
          <strong>Name:</strong> ${match[1]} ${match[2]}<br>
          <strong>SFP ID:</strong> ${match[0]}<br>
          <strong>Status:</strong> ${match[3]}<br>
          <strong>Expiry Date:</strong> ${formatDate(match[4])}${warningNote}
        `;
      } else {
        resultEl.className = 'result';
        resultEl.textContent = 'Driver not found';
      }
    }

    async function lookupVehicle() {
      const raw = document.getElementById('vehicleInput').value.trim();
      const input = 'SFPV-' + padWithZeros(raw);
      const data = await fetchSheetData(VEHICLE_SHEET_URL);
      const match = data.find(row => row[0] === input);
      const resultEl = document.getElementById('vehicleResult');
      if (match) {
        const statusClass = getStatusClass(match[4], match[5]);
        resultEl.className = 'result ' + statusClass;
        const warningNote = statusClass === 'warning' ? '<br><em>Note: Expiry within 30 days</em>' : '';
        resultEl.innerHTML = `
          <strong>Type:</strong> ${match[1]}<br>
          <strong>Plate:</strong> ${match[2]}<br>
          <strong>VIN:</strong> ${match[3]}<br>
          <strong>Status:</strong> ${match[4]}<br>
          <strong>Expiry Date:</strong> ${formatDate(match[5])}${warningNote}
        `;
      } else {
        resultEl.className = 'result';
        resultEl.textContent = 'Vehicle not found';
      }
    }
  </script>
</body>
</html>
