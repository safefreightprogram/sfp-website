<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Portal – Safe Freight Program</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <!-- 🔐 Firebase Auth with Role-Based Access -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBURlJUicOTobRLghN2RyEZfXEZvU_uiYU",
      authDomain: "safe-freight-program.firebaseapp.com",
      projectId: "safe-freight-program",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 🔄 Role-based authentication
    let authInitialized = false;
    
    onAuthStateChanged(auth, async (user) => {
      if (!authInitialized) {
        setTimeout(async () => {
          if (!auth.currentUser) {
            window.location.href = "/login.html";
          } else {
            await checkUserRole(auth.currentUser);
          }
          authInitialized = true;
        }, 800);
      } else if (!user) {
        window.location.href = "/login.html";
      } else {
        await checkUserRole(user);
      }
    });

    // 🔍 Check user role and permissions
    async function checkUserRole(user) {
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        let userRole = 'viewer'; // default role
        
        if (userDoc.exists()) {
          userRole = userDoc.data().role || 'viewer';
        } else {
          // First time user - set as viewer by default
          await setDoc(doc(db, 'users', user.uid), {
            email: user.email,
            role: 'viewer',
            createdAt: new Date()
          });
        }

        // Check admin access
        if (userRole !== 'admin' && userRole !== 'super_admin') {
          // Redirect non-admins to driver lookup
          window.location.href = "/lookup-driver.html";
          return;
        }

        // Initialize admin interface
        initializeAdminInterface(user, userRole);
        hideAuthLoader();
        
      } catch (error) {
        console.error('Error checking user role:', error);
        window.location.href = "/login.html";
      }
    }

    // 🎯 Initialize admin interface
    function initializeAdminInterface(user, role) {
      const logoutLink = document.getElementById("logoutLink");
      const userInfo = document.getElementById("userInfo");
      const roleDisplay = document.getElementById("roleDisplay");
      
      if (logoutLink) logoutLink.classList.remove("hidden");
      
      if (userInfo && user.email) {
        userInfo.textContent = user.email;
        userInfo.classList.remove("hidden");
      }

      if (roleDisplay) {
        roleDisplay.textContent = role === 'super_admin' ? 'Super Admin' : 'Admin';
        roleDisplay.classList.remove("hidden");
      }

      // Store user info globally for use in forms
      window.currentUser = { uid: user.uid, email: user.email, role: role };
    }

    // 🔄 Hide auth loader
    function hideAuthLoader() {
      const loader = document.getElementById('authLoader');
      if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 300);
      }
    }

    // 🚪 Enhanced logout
    window.signOutUser = () => {
      const logoutBtn = document.getElementById("logoutLink");
      const originalText = logoutBtn.textContent;
      
      logoutBtn.textContent = "Signing out...";
      logoutBtn.style.pointerEvents = "none";
      
      signOut(auth)
        .then(() => window.location.href = "/login.html")
        .catch(err => {
          console.error("Logout failed:", err);
          alert("Logout failed: " + err.message);
          logoutBtn.textContent = originalText;
          logoutBtn.style.pointerEvents = "auto";
        });
    };

    // 🔧 Make Firestore available globally
    window.db = db;
  </script>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">
<!-- 🔄 Loading overlay -->
<div id="authLoader" class="fixed inset-0 bg-white bg-opacity-95 flex items-center justify-center z-50 transition-opacity duration-300">
  <div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700 mx-auto mb-4"></div>
    <p class="text-gray-600 text-lg">Checking permissions...</p>
  </div>
</div>

<header class="bg-blue-900 text-white sticky top-0 z-50 shadow" x-data="{ open: false, showSearch: false }">
  <div class="max-w-7xl mx-auto p-4 flex justify-between items-center relative">
    <a href="index.html" class="text-xl font-bold transition-transform transform hover:scale-[1.015]">Safe Freight Program</a>
    
    <!-- User info and controls -->
    <div class="flex items-center space-x-4">
      <div class="text-right hidden" id="userInfoContainer">
        <div id="userInfo" class="text-sm text-blue-200"></div>
        <div id="roleDisplay" class="text-xs text-blue-300 font-medium"></div>
      </div>
      
      <button @click="showSearch = !showSearch" class="inline-flex transition-transform transform hover:scale-105">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m1.35-4.65a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </button>
      
      <button @click="open = !open" class="inline-flex transition-transform transform hover:scale-105">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
    
    <!-- Enhanced Admin Navigation -->
    <div x-show="open" @click.away="open = false" x-transition class="absolute top-full right-0 bg-blue-900 text-white text-sm z-50 shadow-md">
      <nav class="flex flex-col">
        <a href="lookup-driver.html" class="block px-4 py-2 hover:bg-blue-800">Driver Lookup</a>
        <a href="lookup-vehicle.html" class="block px-4 py-2 hover:bg-blue-800">Vehicle Lookup</a>
        <div class="border-t border-blue-700 my-1"></div>
        <a href="admin-portal.html" class="block px-4 py-2 bg-blue-800 font-bold">Admin Portal</a>
        <a href="#" onclick="switchTab('drivers')" class="block px-4 py-2 hover:bg-blue-800 pl-6">• Driver Management</a>
        <a href="#" onclick="switchTab('users')" class="block px-4 py-2 hover:bg-blue-800 pl-6">• User Management</a>
        <a href="#" onclick="switchTab('reports')" class="block px-4 py-2 hover:bg-blue-800 pl-6">• Reports</a>
        <div class="border-t border-blue-700 my-1"></div>
        <a href="find-ail.html" class="block px-4 py-2 hover:bg-blue-800">Find AIL</a>
        <a href="training.html" class="block px-4 py-2 hover:bg-blue-800">SFP Training</a>
        <a href="contact.html" class="block px-4 py-2 hover:bg-blue-800">Contact</a>
        <a id="logoutLink" href="#" onclick="signOutUser()" class="block px-4 py-2 text-red-300 hover:bg-red-800 hidden">Logout</a>
      </nav>
    </div>
  </div>
  
  <!-- Search bar -->
  <div class="px-4 pt-2" x-show="showSearch" x-transition>
    <form onsubmit="searchAllRecords(event)">
      <input type="search" name="q" id="globalSearch" placeholder="Search drivers, vehicles, users..."
             class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-500 text-black">
    </form>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Page Title -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-blue-800">Admin Portal</h1>
    <p class="text-gray-600 mt-2">Manage drivers, vehicles, users, and system settings</p>
  </div>

  <!-- Tab Navigation -->
  <div class="mb-8">
    <nav class="flex space-x-8 border-b border-gray-200">
      <button onclick="switchTab('dashboard')" id="tab-dashboard" class="border-b-2 border-blue-500 text-blue-600 font-medium pb-2 px-1">Dashboard</button>
      <button onclick="switchTab('drivers')" id="tab-drivers" class="text-gray-500 hover:text-gray-700 pb-2 px-1">Driver Management</button>
      <button onclick="switchTab('vehicles')" id="tab-vehicles" class="text-gray-500 hover:text-gray-700 pb-2 px-1">Vehicle Management</button>
      <button onclick="switchTab('users')" id="tab-users" class="text-gray-500 hover:text-gray-700 pb-2 px-1">User Management</button>
      <button onclick="switchTab('reports')" id="tab-reports" class="text-gray-500 hover:text-gray-700 pb-2 px-1">Reports</button>
    </nav>
  </div>

  <!-- Dashboard Tab -->
  <div id="content-dashboard" class="tab-content">
    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
          <div class="p-3 bg-blue-100 rounded-full">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-500">Total Drivers</h3>
            <p class="text-2xl font-bold text-gray-900" id="stat-total-drivers">Loading...</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
          <div class="p-3 bg-green-100 rounded-full">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-500">Active</h3>
            <p class="text-2xl font-bold text-green-600" id="stat-active-drivers">Loading...</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
          <div class="p-3 bg-yellow-100 rounded-full">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-500">Expiring Soon</h3>
            <p class="text-2xl font-bold text-yellow-600" id="stat-expiring-drivers">Loading...</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center">
          <div class="p-3 bg-red-100 rounded-full">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-gray-500">Expired</h3>
            <p class="text-2xl font-bold text-red-600" id="stat-expired-drivers">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-lg font-medium mb-4">Recent Activity</h2>
      <div id="recent-activity" class="space-y-3">
        <p class="text-gray-500">Loading recent activity...</p>
      </div>
    </div>
  </div>

  <!-- Driver Management Tab -->
  <div id="content-drivers" class="tab-content hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Add New Driver Form -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-lg font-medium mb-4">Add New Driver</h2>
          <form id="addDriverForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
              <input type="text" id="firstName" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" placeholder="John">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Surname *</label>
              <input type="text" id="surname" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" placeholder="Smith">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Driver ID *</label>
              <div class="flex">
                <span class="bg-gray-100 border border-r-0 border-gray-300 px-3 py-2 text-gray-500 rounded-l-md">SFPD-</span>
                <input type="text" id="driverId" required pattern="[0-9]{6}" class="flex-1 border border-gray-300 rounded-r-md px-3 py-2 focus:ring-2 focus:ring-blue-500" placeholder="001234">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date *</label>
              <input type="date" id="expiryDate" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Photo Upload</label>
              <input type="file" id="photoUpload" accept="image/*" class="w-full border border-gray-300 rounded-md px-3 py-2">
              <p class="text-xs text-gray-500 mt-1">Recommended: 300x400px passport-style photo</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Certifications</label>
              <div class="space-y-2">
                <label class="flex items-center">
                  <input type="checkbox" id="cert-slp" class="mr-2">
                  <span class="text-sm">SLP (Fuels)</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" id="cert-sup" class="mr-2">
                  <span class="text-sm">SUP (Fuels)</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" id="cert-sdp" class="mr-2">
                  <span class="text-sm">SDP</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" id="cert-dg" class="mr-2">
                  <span class="text-sm">Dangerous Goods</span>
                </label>
              </div>
            </div>
            
            <button type="submit" id="addDriverBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
              Create Driver & Generate Card
            </button>
          </form>
        </div>
      </div>

      <!-- Driver List -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-md">
          <div class="p-6 border-b">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-medium">Driver List</h2>
              <div class="flex space-x-3">
                <input type="search" id="driverSearch" placeholder="Search drivers..." class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                <button onclick="exportDrivers()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                  Export CSV
                </button>
                <button onclick="importDrivers()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                  Import CSV
                </button>
              </div>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Driver</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expiry</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Certifications</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="driverTableBody" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading drivers...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vehicle Management Tab -->
  <div id="content-vehicles" class="tab-content hidden">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-lg font-medium mb-4">Vehicle Management</h2>
      <p class="text-gray-600">Vehicle management functionality will be implemented here.</p>
      <div class="mt-4 p-4 bg-blue-50 rounded-lg">
        <p class="text-blue-800 font-medium">Coming Soon:</p>
        <ul class="text-blue-700 mt-2 space-y-1">
          <li>• Add/edit vehicle information</li>
          <li>• QR code generation for equipment</li>
          <li>• Inspection scheduling and tracking</li>
          <li>• Equipment compliance monitoring</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- User Management Tab -->
  <div id="content-users" class="tab-content hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Add User Form -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-lg font-medium mb-4">Add New User</h2>
          <form id="addUserForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
              <input type="email" id="userEmail" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
              <select id="userRole" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                <option value="">Select role...</option>
                <option value="viewer">Viewer (Lookup only)</option>
                <option value="ail">AIL (Inspection portal)</option>
                <option value="admin">Admin (Full management)</option>
                <option value="super_admin">Super Admin (System-wide)</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Organization</label>
              <input type="text" id="userOrg" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" placeholder="Company name">
            </div>
            
            <button type="submit" id="addUserBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
              Create User Account
            </button>
          </form>
        </div>
      </div>

      <!-- User List -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-md">
          <div class="p-6 border-b">
            <h2 class="text-lg font-medium">User Management</h2>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Organization</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Login</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="userTableBody" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading users...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Tab -->
  <div id="content-reports" class="tab-content hidden">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-medium mb-4">Expiry Reports</h2>
        <div class="space-y-3">
          <button onclick="generateExpiryReport()" class="w-full text-left p-3 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
            <div class="font-medium">Drivers Expiring This Month</div>
            <div class="text-sm text-gray-500">Generate report of drivers requiring renewal</div>
          </button>
          <button onclick="generateOverdueReport()" class="w-full text-left p-3 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
            <div class="font-medium">Overdue Renewals</div>
            <div class="text-sm text-gray-500">List of expired credentials</div>
          </button>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-medium mb-4">System Reports</h2>
        <div class="space-y-3">
          <button onclick="generateActivityReport()" class="w-full text-left p-3 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
            <div class="font-medium">User Activity Report</div>
            <div class="text-sm text-gray-500">Track login and system usage</div>
          </button>
          <button onclick="generateAuditReport()" class="w-full text-left p-3 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
            <div class="font-medium">Audit Trail</div>
            <div class="text-sm text-gray-500">Complete system audit log</div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Messages -->
  <div id="statusMessage" class="fixed bottom-4 right-4 max-w-sm hidden">
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4">
      <div id="statusContent"></div>
    </div>
  </div>
</main>

<footer class="bg-gray-100 border-t border-gray-200 text-sm text-center text-gray-600 p-4 mt-8">
  &copy; 2025 Safe Freight Program. All rights reserved.
</footer>

<!-- 📜 Admin Portal JavaScript -->
<script>
  const DRIVER_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ/gviz/tq?tqx=out:json';
  const SPREADSHEET_ID = '1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ';
  
  let driversData = [];
  let usersData = [];

  // 🔄 Initialize admin portal
  document.addEventListener('DOMContentLoaded', function() {
    // Show user info container when auth completes
    setTimeout(() => {
      const container = document.getElementById('userInfoContainer');
      if (container) container.classList.remove('hidden');
    }, 1000);
    
    // Load initial data
    loadDashboardData();
    loadDriversData();
    loadUsersData();
  });

  // 📊 Tab Management
  function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden');
    });
    
    // Remove active styles from all tabs
    document.querySelectorAll('[id^="tab-"]').forEach(tab => {
      tab.classList.remove('border-blue-500', 'text-blue-600');
      tab.classList.add('text-gray-500');
    });
    
    // Show selected tab content
    document.getElementById(`content-${tabName}`).classList.remove('hidden');
    
    // Style active tab
    const activeTab = document.getElementById(`tab-${tabName}`);
    activeTab.classList.remove('text-gray-500');
    activeTab.classList.add('border-blue-500', 'text-blue-600');
    
    // Load data for specific tabs
    if (tabName === 'drivers') {
      loadDriversData();
    } else if (tabName === 'users') {
      loadUsersData();
    }
  }

  // 📊 Dashboard Data Loading
  async function loadDashboardData() {
    try {
      const data = await fetchSheetData(DRIVER_SHEET_URL);
      
      const total = data.length;
      const active = data.filter(row => row[3] === 'Active').length;
      const expiring = data.filter(row => row[3] === 'Expires Soon').length;
      const expired = data.filter(row => row[3] === 'Expired').length;
      
      document.getElementById('stat-total-drivers').textContent = total;
      document.getElementById('stat-active-drivers').textContent = active;
      document.getElementById('stat-expiring-drivers').textContent = expiring;
      document.getElementById('stat-expired-drivers').textContent = expired;
      
      // Load recent activity
      loadRecentActivity();
      
    } catch (error) {
      console.error('Error loading dashboard data:', error);
      showStatus('Error loading dashboard data', 'error');
    }
  }

  // 📋 Recent Activity
  function loadRecentActivity() {
    const activities = [
      { action: 'New driver added', user: 'Admin', time: '2 hours ago', type: 'success' },
      { action: 'Driver credentials renewed', user: 'Admin', time: '5 hours ago', type: 'info' },
      { action: 'User role updated', user: 'Admin', time: '1 day ago', type: 'warning' },
      { action: 'Bulk import completed', user: 'Admin', time: '2 days ago', type: 'success' }
    ];
    
    const activityHtml = activities.map(activity => `
      <div class="flex items-center justify-between p-3 border border-gray-200 rounded-md">
        <div class="flex items-center">
          <div class="w-3 h-3 rounded-full mr-3 ${
            activity.type === 'success' ? 'bg-green-500' :
            activity.type === 'warning' ? 'bg-yellow-500' :
            activity.type === 'error' ? 'bg-red-500' : 'bg-blue-500'
          }"></div>
          <div>
            <div class="font-medium text-sm">${activity.action}</div>
            <div class="text-xs text-gray-500">by ${activity.user}</div>
          </div>
        </div>
        <div class="text-xs text-gray-400">${activity.time}</div>
      </div>
    `).join('');
    
    document.getElementById('recent-activity').innerHTML = activityHtml;
  }

  // 🔍 Driver Data Management
  async function fetchSheetData(url) {
    const response = await fetch(url);
    const text = await response.text();
    try {
      const json = JSON.parse(text.substr(47).slice(0, -2));
      return json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ''));
    } catch (e) {
      console.error('Failed to parse sheet data:', e);
      return [];
    }
  }

  async function loadDriversData() {
    try {
      driversData = await fetchSheetData(DRIVER_SHEET_URL);
      renderDriverTable(driversData);
    } catch (error) {
      console.error('Error loading drivers:', error);
      showStatus('Error loading driver data', 'error');
    }
  }

  function renderDriverTable(data) {
    const tbody = document.getElementById('driverTableBody');
    
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No drivers found</td></tr>';
      return;
    }
    
    const rows = data.map(row => {
      const [id, firstName, surname, status, expiry, qrUrl, photo, slideId, cardPng, slp, sup, sdp, dg] = row;
      
      // Build certification badges
      const certs = [];
      if (slp === 'y') certs.push('<span class="bg-blue-500 text-white px-2 py-1 rounded text-xs">SLP</span>');
      if (sup === 'y') certs.push('<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">SUP</span>');
      if (sdp === 'y') certs.push('<span class="bg-purple-500 text-white px-2 py-1 rounded text-xs">SDP</span>');
      if (dg === 'y') certs.push('<span class="bg-orange-500 text-white px-2 py-1 rounded text-xs">DG</span>');
      
      const statusClass = 
        status === 'Active' ? 'bg-green-100 text-green-800' :
        status === 'Expired' ? 'bg-red-100 text-red-800' :
        'bg-yellow-100 text-yellow-800';
      
      return `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4">
            <div class="flex items-center">
              <div class="w-8 h-8 bg-gray-300 rounded-full mr-3 flex items-center justify-center text-sm font-medium text-gray-600">
                ${firstName ? firstName.charAt(0) : '?'}${surname ? surname.charAt(0) : '?'}
              </div>
              <span class="font-medium">${firstName || ''} ${surname || ''}</span>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500">${id || ''}</td>
          <td class="px-6 py-4">
            <span class="${statusClass} px-2 py-1 rounded text-xs font-medium">${status || 'Unknown'}</span>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500">${expiry || 'N/A'}</td>
          <td class="px-6 py-4">
            <div class="flex flex-wrap gap-1">
              ${certs.join(' ') || '<span class="text-gray-400 text-xs">None</span>'}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="flex space-x-2">
              <button onclick="editDriver('${id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
              <button onclick="renewDriver('${id}')" class="text-green-600 hover:text-green-800 text-sm font-medium">Renew</button>
              <button onclick="suspendDriver('${id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Suspend</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    tbody.innerHTML = rows;
  }

  // 👤 User Management
  async function loadUsersData() {
    // Mock user data for demonstration
    usersData = [
      { email: 'admin@safefreightprogram.com', role: 'super_admin', org: 'Safe Freight Program', lastLogin: '2 hours ago' },
      { email: 'manager@transportco.com', role: 'admin', org: 'Transport Co', lastLogin: '1 day ago' },
      { email: 'inspector@ailcompany.com', role: 'ail', org: 'AIL Company', lastLogin: '3 days ago' }
    ];
    
    renderUserTable(usersData);
  }

  function renderUserTable(data) {
    const tbody = document.getElementById('userTableBody');
    
    const rows = data.map(user => {
      const roleClass = 
        user.role === 'super_admin' ? 'bg-purple-100 text-purple-800' :
        user.role === 'admin' ? 'bg-blue-100 text-blue-800' :
        user.role === 'ail' ? 'bg-green-100 text-green-800' :
        'bg-gray-100 text-gray-800';
      
      const roleDisplay = 
        user.role === 'super_admin' ? 'Super Admin' :
        user.role === 'admin' ? 'Admin' :
        user.role === 'ail' ? 'AIL' :
        'Viewer';
      
      return `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-sm font-medium text-gray-900">${user.email}</td>
          <td class="px-6 py-4">
            <span class="${roleClass} px-2 py-1 rounded text-xs font-medium">${roleDisplay}</span>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500">${user.org || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${user.lastLogin || 'Never'}</td>
          <td class="px-6 py-4">
            <div class="flex space-x-2">
              <button onclick="editUser('${user.email}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
              <button onclick="resetPassword('${user.email}')" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">Reset</button>
              <button onclick="deleteUser('${user.email}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    tbody.innerHTML = rows;
  }

  // 📝 Form Handlers
  document.getElementById('addDriverForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('addDriverBtn');
    const originalText = btn.textContent;
    btn.textContent = 'Creating...';
    btn.disabled = true;
    
    try {
      const formData = {
        id: 'SFPD-' + document.getElementById('driverId').value,
        firstName: document.getElementById('firstName').value,
        surname: document.getElementById('surname').value,
        status: 'Active',
        expiry: document.getElementById('expiryDate').value,
        photo: document.getElementById('photoUpload').files[0],
        certifications: {
          slp: document.getElementById('cert-slp').checked ? 'y' : 'n',
          sup: document.getElementById('cert-sup').checked ? 'y' : 'n',
          sdp: document.getElementById('cert-sdp').checked ? 'y' : 'n',
          dg: document.getElementById('cert-dg').checked ? 'y' : 'n'
        }
      };
      
      // Here you would integrate with Google Sheets API to add the new driver
      console.log('Adding new driver:', formData);
      
      showStatus('Driver created successfully! Card generation in progress...', 'success');
      
      // Reset form
      document.getElementById('addDriverForm').reset();
      
      // Reload drivers table
      setTimeout(() => {
        loadDriversData();
      }, 1000);
      
    } catch (error) {
      console.error('Error creating driver:', error);
      showStatus('Error creating driver: ' + error.message, 'error');
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  });

  document.getElementById('addUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('addUserBtn');
    const originalText = btn.textContent;
    btn.textContent = 'Creating...';
    btn.disabled = true;
    
    try {
      const userData = {
        email: document.getElementById('userEmail').value,
        role: document.getElementById('userRole').value,
        organization: document.getElementById('userOrg').value
      };
      
      // Here you would integrate with Firebase Auth to create the user
      console.log('Creating new user:', userData);
      
      showStatus('User account created successfully!', 'success');
      
      // Reset form
      document.getElementById('addUserForm').reset();
      
      // Reload users table
      setTimeout(() => {
        loadUsersData();
      }, 1000);
      
    } catch (error) {
      console.error('Error creating user:', error);
      showStatus('Error creating user: ' + error.message, 'error');
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  });

  // 🔍 Search Functions
  document.getElementById('driverSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const filteredData = driversData.filter(row => {
      const searchString = `${row[0]} ${row[1]} ${row[2]} ${row[3]}`.toLowerCase();
      return searchString.includes(searchTerm);
    });
    renderDriverTable(filteredData);
  });

  function searchAllRecords(event) {
    event.preventDefault();
    const searchTerm = document.getElementById('globalSearch').value;
    showStatus(`Searching for: ${searchTerm}`, 'info');
    // Implement global search across all records
  }

  // 🛠 Action Functions
  function editDriver(driverId) {
    showStatus(`Edit driver: ${driverId}`, 'info');
    // Implement edit driver modal/form
  }

  function renewDriver(driverId) {
    showStatus(`Renewing driver: ${driverId}`, 'info');
    // Implement renewal process
  }

  function suspendDriver(driverId) {
    if (confirm(`Are you sure you want to suspend ${driverId}?`)) {
      showStatus(`Driver ${driverId} suspended`, 'warning');
      // Implement suspension logic
    }
  }

  function editUser(email) {
    showStatus(`Edit user: ${email}`, 'info');
    // Implement edit user modal/form
  }

  function resetPassword(email) {
    if (confirm(`Send password reset email to ${email}?`)) {
      showStatus(`Password reset sent to ${email}`, 'info');
      // Implement password reset
    }
  }

  function deleteUser(email) {
    if (confirm(`Are you sure you want to delete ${email}?`)) {
      showStatus(`User ${email} deleted`, 'warning');
      // Implement user deletion
    }
  }

  // 📊 Export/Import Functions
  function exportDrivers() {
    showStatus('Exporting driver data...', 'info');
    // Implement CSV export
  }

  function importDrivers() {
    showStatus('Import feature coming soon', 'info');
    // Implement CSV import
  }

  // 📈 Report Functions
  function generateExpiryReport() {
    showStatus('Generating expiry report...', 'info');
    // Implement expiry report generation
  }

  function generateOverdueReport() {
    showStatus('Generating overdue report...', 'info');
    // Implement overdue report generation
  }

  function generateActivityReport() {
    showStatus('Generating activity report...', 'info');
    // Implement activity report generation
  }

  function generateAuditReport() {
    showStatus('Generating audit report...', 'info');
    // Implement audit report generation
  }

  // 💬 Status Message System
  function showStatus(message, type = 'info') {
    const statusEl = document.getElementById('statusMessage');
    const contentEl = document.getElementById('statusContent');
    
    const iconClass = 
      type === 'success' ? 'text-green-600' :
      type === 'error' ? 'text-red-600' :
      type === 'warning' ? 'text-yellow-600' :
      'text-blue-600';
    
    const bgClass = 
      type === 'success' ? 'bg-green-50 border-green-200' :
      type === 'error' ? 'bg-red-50 border-red-200' :
      type === 'warning' ? 'bg-yellow-50 border-yellow-200' :
      'bg-blue-50 border-blue-200';
    
    contentEl.innerHTML = `
      <div class="flex items-center ${bgClass} p-3 rounded-md">
        <div class="${iconClass} mr-2">
          ${type === 'success' ? '✓' : type === 'error' ? '✗' : type === 'warning' ? '⚠' : 'ℹ'}
        </div>
        <span class="text-sm font-medium">${message}</span>
      </div>
    `;
    
    statusEl.classList.remove('hidden');
    
    setTimeout(() => {
      statusEl.classList.add('hidden');
    }, 5000);
  }
</script>

</body>
</html>
