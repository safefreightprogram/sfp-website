<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Find an AIL â€“ Safe Freight Program</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/@googlemaps/markerclustererplus/dist/index.min.js"></script>
  <style>
    #map { width: 100%; height: 400px; }
    .tab-active { background-color: #2563eb; color: white; border-color: #1d4ed8; }
    .tab-inactive { background-color: white; color: #374151; border-color: #d1d5db; }
    .map-info-actions a { margin-left: 0.5rem; text-decoration: underline; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

<!-- header omitted for brevity -->

<main class="max-w-7xl mx-auto px-4 py-4" x-data="ailFinder()">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Find AIL Locations</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
          <div class="relative">
            <input type="text" x-model="searchText" @input="filterLocations()" placeholder="Search company names..." class="w-full pl-8 pr-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
            <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
              <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Filter by State</label>
          <select x-model="selectedState" @change="filterLocations()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
            <option value="all">All States</option>
            <option value="NSW">NSW</option>
            <option value="QLD">QLD</option>
            <option value="VIC">VIC</option>
            <option value="SA">SA</option>
            <option value="WA">WA</option>
            <option value="NT">NT</option>
            <option value="TAS">TAS</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Suburb/City</label>
          <select x-model="selectedSuburb" @change="filterLocations()" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
            <option value="all">All Suburbs</option>
            <template x-for="suburb in suburbs" :key="suburb">
              <option x-text="suburb"></option>
            </template>
          </select>
        </div>
        <button @click="clearFilters()" class="w-full px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md transition-colors text-sm mb-4">Clear Filters</button>
        <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded">
          <strong x-text="filteredLocations.length"></strong> locations found
        </div>
      </div>

<!-- rest of layout continues unchanged until map info panel -->

<div x-show="selectedLocation" x-transition @click.away="selectedLocation = null" class="absolute top-4 left-4 bg-white rounded-lg shadow-lg border border-gray-200 p-4 max-w-sm z-10">
  <template x-if="selectedLocation">
    <div>
      <h3 class="font-semibold text-gray-800 mb-2" x-text="selectedLocation.company"></h3>
      <p class="text-sm text-gray-600 mb-2" x-text="selectedLocation.address"></p>
      <div class="flex items-center justify-between">
        <a :href="'tel:' + selectedLocation.phone" class="text-blue-600 hover:text-blue-700 font-medium text-sm" x-text="selectedLocation.phone"></a>
        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded" x-text="selectedLocation.state"></span>
      </div>
      <div class="flex items-center justify-between mt-2 map-info-actions">
        <a href="#" @click.prevent="navigator.clipboard.writeText(selectedLocation.address)" class="text-sm text-blue-600 hover:text-blue-800">Copy Address</a>
        <a :href="'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(selectedLocation.address)" target="_blank" class="text-sm text-blue-600 hover:text-blue-800">Get Directions</a>
      </div>
    </div>
  </template>
</div>

<!-- JavaScript Alpine Component + Map Code -->
<script>
let map;
let markers = [];
let markerCluster;
let ailData = [];

function ailFinder() {
  return {
    activeTab: 'map',
    selectedState: 'all',
    selectedSuburb: 'all',
    searchText: '',
    filteredLocations: [],
    selectedLocation: null,
    suburbs: [],

    init() {
      ailData = rawAilData;
      this.filteredLocations = ailData;
      this.suburbs = [...new Set(ailData.map(a => a.address.split(',')[1]?.trim()))].sort();
    },

    filterLocations() {
      this.filteredLocations = ailData.filter(location => {
        const matchesSearch = !this.searchText || location.company.toLowerCase().includes(this.searchText.toLowerCase());
        const suburb = location.address.split(',')[1]?.trim();
        const matchesState = this.selectedState === 'all' || location.state === this.selectedState;
        const matchesSuburb = this.selectedSuburb === 'all' || suburb === this.selectedSuburb;
        return matchesSearch && matchesState && matchesSuburb;
      });
      console.log('Search:', this.searchText, '| State:', this.selectedState, '| Suburb:', this.selectedSuburb);
      if (this.activeTab === 'map' && typeof filterMapMarkers === 'function') {
        filterMapMarkers();
      }
    },

    clearFilters() {
      this.searchText = '';
      this.selectedState = 'all';
      this.selectedSuburb = 'all';
      this.filterLocations();
    },

    setActiveTab(tab) {
      this.activeTab = tab;
      if (tab === 'map' && window.google && window.map) {
        setTimeout(() => {
          google.maps.event.trigger(map, 'resize');
          map.setCenter({ lat: -25.2744, lng: 133.7751 });
        }, 100);
      }
    },

    viewOnMap(location) {
      this.activeTab = 'map';
      this.selectedLocation = location;
      if (window.google && window.map) {
        setTimeout(() => {
          google.maps.event.trigger(map, 'resize');
          map.setCenter({ lat: location.lat, lng: location.lng });
          map.setZoom(12);
        }, 100);
      }
    }
  };
}

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 5,
    center: { lat: -25.2744, lng: 133.7751 },
    mapTypeId: 'roadmap',
    styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
  });
  loadMarkers();
  map.addListener('click', function () {
    const appComponent = document.querySelector('[x-data]').__x.$data;
    if (appComponent) appComponent.selectedLocation = null;
  });
}

function loadMarkers() {
  if (markerCluster) markerCluster.clearMarkers();
  markers.forEach(marker => marker.setMap(null));
  markers = [];
  ailData.forEach(ail => {
    const marker = new google.maps.Marker({
      position: { lat: ail.lat, lng: ail.lng },
      title: ail.company,
      icon: {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
          <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" fill="#2563eb" stroke="white" stroke-width="2"/>
          </svg>`),
        scaledSize: new google.maps.Size(20, 20),
        anchor: new google.maps.Point(10, 10)
      }
    });
    marker.addListener("click", () => {
      const appComponent = document.querySelector('[x-data]').__x.$data;
      appComponent.selectedLocation = ail;
    });
    markers.push(marker);
  });
  markerCluster = new MarkerClusterer(map, markers, {
    imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
  });
}

function filterMapMarkers() {
  const activeFilters = document.querySelector('[x-data]').__x.$data;
  markers.forEach(marker => {
    const ail = ailData.find(a => a.lat === marker.getPosition().lat() && a.lng === marker.getPosition().lng());
    const suburb = ail.address.split(',')[1]?.trim();
    const matchesSearch = !activeFilters.searchText || ail.company.toLowerCase().includes(activeFilters.searchText.toLowerCase());
    const matchesState = activeFilters.selectedState === 'all' || ail.state === activeFilters.selectedState;
    const matchesSuburb = activeFilters.selectedSuburb === 'all' || suburb === activeFilters.selectedSuburb;
    marker.setVisible(matchesSearch && matchesState && matchesSuburb);
  });
}

window.initMap = initMap;
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPnUqhxYzzgoRJ32Rh6-bg5wmKuXtBmKI&callback=initMap&libraries=geometry"></script>
</body>
</html>
