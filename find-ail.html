<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Find an AIL – Safe Freight Program</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <style>
    #map {
      width: 100%;
      height: 500px;
    }
    
    .tab-active {
      background-color: #2563eb;
      color: white;
      border-color: #1d4ed8;
    }
    
    .tab-inactive {
      background-color: white;
      color: #374151;
      border-color: #d1d5db;
    }

    .autocomplete-dropdown {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #d1d5db;
      border-top: none;
      background: white;
      border-radius: 0 0 0.375rem 0.375rem;
    }

    .autocomplete-item {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background-color: #eff6ff;
    }

    .search-hint {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Header with Navigation -->
  <header class="bg-blue-900 text-white sticky top-0 z-50 shadow" x-data="{ open: false, showSearch: false }">
    <div class="max-w-7xl mx-auto p-4 flex justify-between items-center relative">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="transition-transform transform hover:scale-[1.05]">
          <img src="SFP-Logo.png" alt="Safe Freight Program" class="h-8 w-auto">
        </a>
      </div>
      
      <!-- Centered Title -->
      <div class="absolute left-1/2 transform -translate-x-1/2">
        <h1 class="text-xl font-semibold">Find AIL</h1>
      </div>
      
      <!-- Controls -->
      <div class="flex items-center space-x-4">
        <button @click="showSearch = !showSearch" class="inline-flex transition-transform transform hover:scale-105">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m1.35-4.65a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
        
        <button @click="open = !open" class="inline-flex transition-transform transform hover:scale-105">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
      
      <!-- Search bar -->
      <div x-show="showSearch" @click.away="showSearch = false" x-transition 
           class="absolute top-full right-0 bg-blue-900 shadow-md z-40 w-full sm:w-80 md:w-72 lg:w-64">
        <div class="p-4">
          <form action="search.html" method="GET">
            <input type="search" name="q" placeholder="Type a word"
                   class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-500 text-black">
          </form>
        </div>
      </div>
      
      <!-- Navigation menu -->
      <div x-show="open" @click.away="open = false" x-transition 
           class="absolute top-full right-0 bg-blue-900 text-white text-sm z-50 shadow-md"
           :class="showSearch ? 'mt-16 sm:mt-0 sm:right-80 md:right-72 lg:right-64' : ''">
        <nav class="flex flex-col">
          <a href="about.html" class="block px-4 py-2 hover:bg-blue-800">About</a>
          <a href="lookup-driver.html" class="block px-4 py-2 hover:bg-blue-800">Driver Lookup</a>
          <a href="lookup-vehicle.html" class="block px-4 py-2 hover:bg-blue-800">Vehicle Lookup</a>
          <a href="find-ail.html" class="block px-4 py-2 hover:bg-blue-800 bg-blue-800">Find AIL</a>
          <a href="training.html" class="block px-4 py-2 hover:bg-blue-800">SFP Training</a>
          <a href="ail-login.html" class="block px-4 py-2 hover:bg-blue-800">AIL Portal</a>
          <a href="trainer-login.html" class="block px-4 py-2 hover:bg-blue-800">Trainer Login</a>
          <a href="contact.html" class="block px-4 py-2 hover:bg-blue-800">Contact</a>
          <a href="subscription.html" class="block px-4 py-2 hover:bg-blue-800">Subscribe</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-4" x-data="ailFinder()">

    <!-- Side by Side Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Left Side - Search and Filters -->
      <div class="lg:col-span-1">
        <!-- Search Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">Find an Authorised Inspection Location</h2>
          
          <!-- Search Input with Autocomplete -->
          <div class="mb-4 relative">
            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
            <div class="relative">
              <input 
                type="text" 
                x-model="searchText"
                @input="handleSearchInput()"
                @keydown="handleKeyDown($event)"
                @focus="showAutocomplete = true"
                @blur="setTimeout(() => showAutocomplete = false, 200)"
                placeholder="Start typing company name or location..."
                class="w-full pl-8 pr-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
              >
              <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>
            
            <!-- Search Hint -->
            <div class="search-hint">Type and press Enter to search, or select from suggestions</div>
            
            <!-- Autocomplete Dropdown -->
            <div x-show="showAutocomplete && autocompleteItems.length > 0" 
                 class="absolute z-10 w-full autocomplete-dropdown">
              <template x-for="(item, index) in autocompleteItems.slice(0, 8)" :key="item.id">
                <div class="autocomplete-item" 
                     :class="{ 'selected': index === selectedIndex }"
                     @click="selectAutocompleteItem(item)">
                  <div class="font-medium text-sm" x-text="item.company"></div>
                  <div class="text-xs text-gray-500" x-text="item.address"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- Near Me Search -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Find AIL Near Me</label>
            <div class="relative">
              <input 
                type="text" 
                x-model="nearMeSearchText"
                @input="handleNearMeInput()"
                @keydown="handleNearMeKeyDown($event)"
                @focus="showNearMeAutocomplete = true"
                @blur="setTimeout(() => showNearMeAutocomplete = false, 200)"
                placeholder="Enter your address, suburb, or postcode..."
                class="w-full pl-8 pr-16 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
              >
              <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <button 
                @click="getCurrentLocation()"
                :disabled="gettingLocation"
                class="absolute inset-y-0 right-0 pr-2 flex items-center text-blue-600 hover:text-blue-700 disabled:text-gray-400"
                title="Use my current location"
              >
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              </button>
            </div>
            
            <!-- Near Me Search Hint -->
            <div class="search-hint">
              <span x-show="!gettingLocation">Enter your location or click the arrow to use GPS</span>
              <span x-show="gettingLocation" class="text-blue-600">Getting your location...</span>
            </div>
            
            <!-- Near Me Autocomplete -->
            <div x-show="showNearMeAutocomplete && nearMeAutocompleteItems.length > 0" 
                 class="absolute z-10 w-full autocomplete-dropdown">
              <template x-for="(item, index) in nearMeAutocompleteItems.slice(0, 6)" :key="index">
                <div class="autocomplete-item" 
                     :class="{ 'selected': index === nearMeSelectedIndex }"
                     @click="selectNearMeItem(item)">
                  <div class="font-medium text-sm" x-text="item.formatted_address || item.description"></div>
                </div>
              </template>
            </div>
            
            <!-- Distance Selector -->
            <div x-show="userLocation" class="mt-2 flex items-center space-x-2">
              <label class="text-xs text-gray-600">Within:</label>
              <select 
                x-model="searchRadius"
                @change="performNearMeSearch()"
                class="text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
              >
                <option value="25">25 km</option>
                <option value="50">50 km</option>
                <option value="100">100 km</option>
                <option value="200">200 km</option>
                <option value="500">500 km</option>
              </select>
              <button 
                @click="clearNearMeSearch()"
                class="text-xs text-gray-500 hover:text-gray-700 underline"
              >
                Clear
              </button>
            </div>
          </div>

          <!-- State Filter -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by State</label>
            <select 
              x-model="selectedState"
              @change="handleStateChange()"
              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="all">All States</option>
              <option value="NSW">NSW</option>
              <option value="QLD">QLD</option>
              <option value="VIC">VIC</option>
              <option value="SA">SA</option>
              <option value="WA">WA</option>
              <option value="NT">NT</option>
              <option value="TAS">TAS</option>
            </select>
          </div>

          <!-- Clear Button -->
          <button 
            @click="clearFilters()"
            class="w-full px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md transition-colors text-sm mb-4"
          >
            Clear Filters
          </button>

          <!-- Results Count -->
          <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded">
            <strong x-text="filteredLocations.length"></strong> locations found
          </div>
        </div>
      </div>

      <!-- Right Side - Map and List Tabs -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          
          <!-- Tab Headers -->
          <div class="border-b border-gray-200">
            <div class="flex">
              <button 
                @click="setActiveTab('map')"
                :class="activeTab === 'map' ? 'tab-active' : 'tab-inactive'"
                class="flex-1 px-4 py-3 font-medium text-sm border-r border-gray-200 transition-all"
              >
                📍 Map
              </button>
              <button 
                @click="setActiveTab('list')"
                :class="activeTab === 'list' ? 'tab-active' : 'tab-inactive'"
                class="flex-1 px-4 py-3 font-medium text-sm transition-all"
              >
                📋 List
              </button>
            </div>
          </div>

          <!-- Tab Content Container -->
          <div class="relative h-[500px]">
            
            <!-- Map Tab Content -->
            <div x-show="activeTab === 'map'" class="absolute inset-0">
              <div id="map" class="w-full h-full"></div>
              
              <!-- Map Info Panel -->
              <div x-show="selectedLocation" 
                   x-transition
                   class="absolute top-4 left-4 bg-white rounded-lg shadow-lg border border-gray-200 max-w-sm z-10 max-h-96 overflow-hidden">
                <template x-if="selectedLocation">
                  <div>
                    <!-- Single AIL Display -->
                    <div x-show="!selectedLocation.isCluster" class="p-4">
                      <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800 pr-2" x-text="selectedLocation.company"></h3>
                        <button @click="selectedLocation = null" 
                                class="text-gray-400 hover:text-gray-600 flex-shrink-0">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                          </svg>
                        </button>
                      </div>
                      <p class="text-sm text-gray-600 mb-3" x-text="selectedLocation.address"></p>
                      
                      <div class="flex items-center justify-between mb-3">
                        <a :href="'tel:' + selectedLocation.phone" 
                           class="text-blue-600 hover:text-blue-700 font-medium text-sm" 
                           x-text="selectedLocation.phone"></a>
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded" 
                              x-text="selectedLocation.state"></span>
                      </div>
                      
                      <div x-show="selectedLocation.distance" class="mb-3">
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                          <span x-text="Math.round(selectedLocation.distance)"></span> km away
                        </span>
                      </div>
                      
                      <!-- Action Buttons -->
                      <div class="flex flex-col space-y-2">
                        <button 
                          @click="getDirections(selectedLocation)"
                          class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-2 rounded transition-colors flex items-center justify-center">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          </svg>
                          Get Directions
                        </button>
                        <button 
                          @click="contactAIL(selectedLocation)"
                          class="w-full bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-2 rounded transition-colors flex items-center justify-center">
                          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                          </svg>
                          Contact AIL
                        </button>
                      </div>
                    </div>
                    
                    <!-- Cluster Display -->
                    <div x-show="selectedLocation.isCluster" class="max-h-96">
                      <div class="p-4 border-b border-gray-200 bg-gray-50">
                        <div class="flex justify-between items-center">
                          <h3 class="font-semibold text-gray-800">
                            <span x-text="selectedLocation.ailsAtLocation.length"></span> AILs at this location
                          </h3>
                          <button @click="selectedLocation = null" 
                                  class="text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                          </button>
                        </div>
                        <p class="text-sm text-gray-600 mt-1" x-text="selectedLocation.address"></p>
                      </div>
                      
                      <!-- Scrollable AIL List -->
                      <div class="overflow-y-auto max-h-80">
                        <template x-for="(ail, index) in selectedLocation.ailsAtLocation" :key="ail.id">
                          <div class="p-4 border-b border-gray-100 last:border-b-0">
                            <div class="mb-2">
                              <h4 class="font-medium text-gray-800 text-sm" x-text="ail.company"></h4>
                              <p class="text-xs text-gray-500 mt-1" x-text="ail.address"></p>
                            </div>
                            
                            <div class="flex items-center justify-between mb-3">
                              <a :href="'tel:' + ail.phone" 
                                 class="text-blue-600 hover:text-blue-700 font-medium text-sm" 
                                 x-text="ail.phone"></a>
                              <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded" 
                                    x-text="ail.state"></span>
                            </div>
                            
                            <div x-show="ail.distance" class="mb-3">
                              <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                                <span x-text="Math.round(ail.distance)"></span> km away
                              </span>
                            </div>
                            
                            <!-- Action Buttons for each AIL -->
                            <div class="flex flex-col space-y-2">
                              <button 
                                @click="getDirections(ail)"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-2 rounded transition-colors flex items-center justify-center">
                                <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                </svg>
                                Get Directions
                              </button>
                              <button 
                                @click="contactAIL(ail)"
                                class="w-full bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-2 rounded transition-colors flex items-center justify-center">
                                <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                </svg>
                                Contact AIL
                              </button>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- List Tab Content -->
            <div x-show="activeTab === 'list'" class="absolute inset-0 p-4 overflow-y-auto">
              <div class="space-y-3">
                <template x-for="location in filteredLocations" :key="location.id">
                  <div class="border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow bg-gray-50">
                    <div class="flex justify-between items-start mb-2">
                      <h3 class="font-semibold text-gray-800 text-sm leading-tight flex-1 pr-2" x-text="location.company"></h3>
                      <div class="flex items-center space-x-2 flex-shrink-0">
                        <span x-show="location.distance" class="bg-green-100 text-green-800 text-xs px-1.5 py-0.5 rounded" x-text="Math.round(location.distance) + ' km'"></span>
                        <span class="bg-blue-100 text-blue-800 text-xs px-1.5 py-0.5 rounded" x-text="location.state"></span>
                      </div>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-2 leading-relaxed" x-text="location.address"></p>
                    
                    <div class="flex items-center justify-between">
                      <a :href="'tel:' + location.phone" 
                         class="text-blue-600 hover:text-blue-700 font-medium text-sm flex items-center">
                        📞 <span class="ml-1" x-text="location.phone"></span>
                      </a>
                      <button 
                        @click="viewOnMap(location)"
                        class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded transition-colors">
                        View on Map
                      </button>
                    </div>
                  </div>
                </template>
                
                <!-- No results -->
                <div x-show="filteredLocations.length === 0" class="text-center py-8">
                  <div class="text-3xl mb-2">🔍</div>
                  <p class="text-gray-500">No locations found</p>
                  <p x-show="userLocation" class="text-gray-400 text-sm mt-1">Try increasing the search radius</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-100 border-t border-gray-200 text-sm text-center text-gray-600 p-4 mt-8">
    &copy; 2025 Safe Freight Program. All rights reserved.
  </footer>

  <script>
    // Global variables
    let map;
    let markers = [];
    let ailData = [];
    let mapInitialized = false;
    
    // Global reference to Alpine component for Google Maps callbacks
    let ailFinderComponent = null;

    // Australia bounds for fitting map to country
    const australiaBounds = {
      north: -9.5,
      south: -43.5,
      west: 113.0,
      east: 153.0
    };

    // FIXED: Updated state bounds with better coordinates for proper zooming
    const stateBounds = {
      NSW: {
        north: -28.0,
        south: -37.8,
        west: 140.5,
        east: 154.0
      },
      QLD: {
        north: -9.5,
        south: -29.5,
        west: 137.5,
        east: 154.2
      },
      VIC: {
        north: -33.5,
        south: -39.5,
        west: 140.5,
        east: 150.2
      },
      SA: {
        north: -25.5,
        south: -38.5,
        west: 129.0,
        east: 141.5
      },
      WA: {
        north: -13.0,
        south: -35.5,
        west: 112.5,
        east: 129.5
      },
      NT: {
        north: -10.5,
        south: -26.5,
        west: 128.5,
        east: 138.5
      },
      TAS: {
        north: -39.0,
        south: -44.0,
        west: 143.5,
        east: 148.8
      }
    };

    // Complete AIL Data from Google Sheet - All 79 locations
    const rawAilData = [
      // NSW Locations (12)
      {id: 239, company: "Aero Refuellers", address: "Hanger 8-11 Ogden Street, East Albury NSW 2640", phone: "02 6041 1599", lat: -36.071665, lng: 146.9537581, state: "NSW"},
      {id: 222, company: "Australian Fuelling Systems & Equip", address: "7-11 Armstrong Street, Tamworth NSW 2340", phone: "02 6760 7816", lat: -31.0791106, lng: 150.8532199, state: "NSW"},
      {id: 220, company: "Doug Sutherland Truck Repairs", address: "222 Urana Street, Wagga Wagga NSW 2650", phone: "02 6925 2094", lat: -35.1252742, lng: 147.3413631, state: "NSW"},
      {id: 207, company: "Durham Fabrications", address: "4 Ranton Street, Cardiff NSW 2285", phone: "02 4956 8868", lat: -32.9444557, lng: 151.6476872, state: "NSW"},
      {id: 208, company: "Durham Fabrications", address: "Cardiff NSW 2285", phone: "02 4956 8868", lat: -32.9110348, lng: 151.6187438, state: "NSW"},
      {id: 241, company: "Engineering, Mining, Petroleum Pty Ltd", address: "1015 Armidale Road, Nemingha NSW 2340", phone: "02 6760 9548", lat: -31.1241211, lng: 150.9866511, state: "NSW"},
      {id: 237, company: "Express Engineering Australia Pty Ltd", address: "20R Yarrandale Road, Dubbo NSW 2830", phone: "02 6884 2723", lat: -32.2238944, lng: 148.6320896, state: "NSW"},
      {id: 201, company: "Fuel Spec Services", address: "13 Hume Road, Smithfield NSW 2164", phone: "1300 113 541", lat: -33.8377348, lng: 150.9312227, state: "NSW"},
      {id: 205, company: "Fuel Spec Services", address: "Smithfield NSW 2164", phone: "1301 113 541", lat: -33.8492918, lng: 150.9132815, state: "NSW"},
      {id: 221, company: "Hancock & Owen Services Pty Ltd", address: "38 Parker Street, Carrington NSW 2294", phone: "02 4969 5390", lat: -32.905424, lng: 151.7666222, state: "NSW"},
      {id: 235, company: "Heavy Haulage Maintenance", address: "28 Old Punt Road, Tomago NSW 2322", phone: "02 4964 9475", lat: -32.8209927, lng: 151.7028008, state: "NSW"},
      {id: 200, company: "WBG Trailer Repairs", address: "Lot 1 Yarrunga Road, Prestons NSW 2170", phone: "02 9608 2288", lat: -33.9363776, lng: 150.8603357, state: "NSW"},
      
      // QLD Locations (28)
      {id: 410, company: "Brown & Hurley", address: "2 Central Park Drive, South Mackay QLD 4740", phone: "07 4952 3722", lat: -21.1755649, lng: 149.1661223, state: "QLD"},
      {id: 462, company: "Brown and Hurley", address: "28-30 Carrington Road, Torrington QLD 4350", phone: "07 4690 7300", lat: -27.5487615, lng: 151.8968995, state: "QLD"},
      {id: 424, company: "Central Coast Services Mackay", address: "Lot 1 Presto Avenue, Outer Harbour QLD 4740", phone: "07 4955 4922", lat: -21.1101141, lng: 149.2110353, state: "QLD"},
      {id: 452, company: "CQ Diesel Fitting", address: "23 Bensted Road, Gladstone QLD 4680", phone: "07 4972 7401", lat: -23.8584217, lng: 151.229545, state: "QLD"},
      {id: 460, company: "CQ Diesel Fitting", address: "87 Links Avenue, Eagle Farm QLD 4009", phone: "07 3268 2543", lat: -27.4374068, lng: 153.0867816, state: "QLD"},
      {id: 461, company: "CQ Diesel Fitting", address: "112 Spiller Avenue, Outer Harbour QLD 4740", phone: "07 4955 0324", lat: -21.1007206, lng: 149.2153069, state: "QLD"},
      {id: 415, company: "Fuel Service Australia", address: "29 Sandmere Road, Pinkenba QLD 4008", phone: "0433 450 603", lat: -27.392153, lng: 153.1418447, state: "QLD"},
      {id: 411, company: "Haulmark Trailers (Australia)", address: "32 Suscatand Street, Rocklea QLD 4106", phone: "07 3277 8844", lat: -27.5576397, lng: 152.9970275, state: "QLD"},
      {id: 412, company: "Haulmark Trailers (Australia)", address: "42 Kupfer Drive, Roseneath QLD 4817", phone: "07 4144 2803", lat: -19.3759709, lng: 146.8333008, state: "QLD"},
      {id: 405, company: "Holmwood Highgate (Aust) Pty Ltd", address: "20 Burchill Street, Loganholme QLD 4129", phone: "07 3440 9000", lat: -27.6821993, lng: 153.191783, state: "QLD"},
      {id: 401, company: "Liquip Sales (QLD) Pty Ltd", address: "730 Macarthur Avenue, Pinkenba QLD 4008", phone: "07 3633 9100", lat: -27.4403414, lng: 153.0784498, state: "QLD"},
      {id: 414, company: "Liquip Sales NQ", address: "659-665 Ingham Road, Bohle QLD 4814", phone: "07 4774 8060", lat: -19.260684, lng: 146.73731, state: "QLD"},
      {id: 407, company: "Northern Refuelling Maintenance Pty Ltd", address: "3 Marsh Street, Woree QLD 4868", phone: "07 4033 2199", lat: -16.9574228, lng: 145.7520655, state: "QLD"},
      {id: 435, company: "NQ Fuel & Maintenance", address: "485 Woolcock Street, Garbutt QLD 4814", phone: "07 4774 3334", lat: -19.2671514, lng: 146.7543566, state: "QLD"},
      {id: 436, company: "NQ Fuel & Maintenance", address: "Garbutt QLD 4814", phone: "07 4774 3334", lat: -19.2878252, lng: 146.7552341, state: "QLD"},
      {id: 432, company: "NQ Petro Pty Ltd", address: "14 Atticus Street, Woree QLD 4868", phone: "07 4054 5100", lat: -16.9549579, lng: 145.7481359, state: "QLD"},
      {id: 408, company: "Queensland Tanker Services", address: "3-5 Vennard Street, Townsville QLD 4810", phone: "0417 356 568", lat: -19.2697953, lng: 146.7560216, state: "QLD"},
      {id: 409, company: "Queensland Tanker Services", address: "Townsville QLD 4810", phone: "0417 356 568", lat: -19.35682, lng: 147.0379125, state: "QLD"},
      {id: 426, company: "RGM Maintenance Pty Ltd", address: "32 Ashover Road, Rocklea QLD 4106", phone: "07 3277 7616", lat: -27.559777, lng: 153.0085609, state: "QLD"},
      {id: 427, company: "RGM Maintenance Pty Ltd", address: "24 Curley Circuit, Roseneath QLD 4817", phone: "07 4421 9100", lat: -19.3747045, lng: 146.830337, state: "QLD"},
      {id: 418, company: "RGM Maintenance Pty Ltd", address: "24 Curley Circuit, Roseneath QLD 4817", phone: "07 4421 9100", lat: -19.3747045, lng: 146.830337, state: "QLD"},
      {id: 465, company: "RGM Maintenance Pty Ltd", address: "500 Milton Street, Paget QLD 4740", phone: "0406 495 734", lat: -21.1891009, lng: 149.1706871, state: "QLD"},
      {id: 417, company: "RGM Maintenance Pty Ltd", address: "500 Milton Street, Paget QLD 4740", phone: "0406 495 734", lat: -21.1891009, lng: 149.1706871, state: "QLD"},
      {id: 470, company: "RGM Maintenance Pty Ltd", address: "351 Main Myrtletown Road, Pinkenba QLD 4008", phone: "07 3260 1224", lat: -27.4159631, lng: 153.1255774, state: "QLD"},
      {id: 471, company: "RGM Maintenance Pty Ltd", address: "63-67 Aumuller Street, Portsmouth QLD 4868", phone: "07 4080 7500", lat: -16.9409518, lng: 145.7658438, state: "QLD"},
      {id: 472, company: "RGM Maintenance Pty Ltd", address: "1033 Bruce Hwy, Parkhurst QLD 4701", phone: "07 4923 1000", lat: -23.2861232, lng: 150.5089416, state: "QLD"},
      {id: 457, company: "Stephen Symes", address: "Mobile Inspector, QLD", phone: "0403 277 637", lat: -22.575197, lng: 144.0847926, state: "QLD"},
      {id: 416, company: "Sustar Engineering Pty Ltd", address: "Lot 244 Fison Street, Gladstone QLD 4680", phone: "07 4972 5366", lat: -23.8415948, lng: 151.2497708, state: "QLD"},
      
      // VIC Locations (13)
      {id: 305, company: "Acme Oil Equipment Services Pty Ltd", address: "32 Greens Road, Dandenong South VIC 3175", phone: "03 9791 3255", lat: -38.015738, lng: 145.2209347, state: "VIC"},
      {id: 320, company: "Australian Tank Engineering", address: "29-31 Vella Drive, Sunshine VIC 3020", phone: "03 9310 2722", lat: -37.8056095, lng: 144.828958, state: "VIC"},
      {id: 310, company: "Echuca Engineering", address: "13 Mundarra Road, Echuca VIC 3564", phone: "03 5480 6921", lat: -36.141996, lng: 144.762877, state: "VIC"},
      {id: 304, company: "Evolution Tanker Repairs", address: "371 Rossiter Road, Koo Wee Rup VIC 3981", phone: "0424 099 314", lat: -38.19564, lng: 145.497366, state: "VIC"},
      {id: 313, company: "G & S Bigham", address: "87 Golf Course Road, Horsham VIC 3400", phone: "03 5382 5893", lat: -36.7376332, lng: 142.1970197, state: "VIC"},
      {id: 303, company: "Holmwood Group VIC", address: "425 Fitzgerald Road, Derrimut VIC 3030", phone: "03 9936 0360", lat: -37.8008048, lng: 144.787899, state: "VIC"},
      {id: 324, company: "Johnson's Truck & Coach Service Pty Ltd", address: "579 Benetook Avenue, Mildura VIC 3500", phone: "03 5024 4666", lat: -34.2092698, lng: 142.1616144, state: "VIC"},
      {id: 322, company: "Liquip Victoria (Fuelcraft)", address: "476 Boundary Rd, Derrimut VIC 3030", phone: "03 9311 7822", lat: -37.8104863, lng: 144.759139, state: "VIC"},
      {id: 302, company: "Marshall Lethlean", address: "20 Whitfield Blvd, Cranbourne West VIC 3977", phone: "03 8788 5400", lat: -38.0804675, lng: 145.2414944, state: "VIC"},
      {id: 323, company: "Progress Transport Services Pty Ltd", address: "Shed 2, Coghlans Road, Warrnambool VIC 3280", phone: "0429 320 420", lat: -38.3523961, lng: 142.4661686, state: "VIC"},
      {id: 307, company: "Starworx", address: "5A Westwood Drive, Ravenhall VIC 3029", phone: "0459 839 072", lat: -37.7717246, lng: 144.7551499, state: "VIC"},
      {id: 326, company: "Tieman Tankers", address: "184-186 Northbourne Road, Campbellfield VIC 3061", phone: "03 9469 6701", lat: -37.6482781, lng: 144.9611406, state: "VIC"},
      {id: 314, company: "Transport Preventative Maintenance P/Ltd", address: "10-14 Churchill Street, Williamstown VIC 3016", phone: "03 9397 1135", lat: -37.8521501, lng: 144.8627896, state: "VIC"},
      
      // SA Locations (5)
      {id: 503, company: "Haulmark Trailers Australia", address: "97-99 West Avenue, Edinburgh SA 5111", phone: "08 8283 8585", lat: -34.7327779, lng: 138.6344371, state: "SA"},
      {id: 506, company: "Hoss Engineering & Maintenance Service", address: "3 Mallee Crescent, Port Lincoln SA 5606", phone: "0427 518 945", lat: -34.7340247, lng: 135.8623913, state: "SA"},
      {id: 502, company: "Liquip (SA) Pty Ltd", address: "10 Creswell Road, Largs North SA 5016", phone: "08 8341 7009", lat: -34.8213309, lng: 138.5037846, state: "SA"},
      {id: 512, company: "Mechanical & Technical Testing", address: "40 Butler Terrace, Naracoorte SA 5271", phone: "08 8762 2379", lat: -36.9624232, lng: 140.7370711, state: "SA"},
      {id: 501, company: "OES Oil Engineering Services", address: "5 Creswell Road, Largs North SA 5016", phone: "08 8341 5677", lat: -34.8222069, lng: 138.5031614, state: "SA"},
      
      // WA Locations (12)
      {id: 657, company: "Fuel Maintenance and Engineering", address: "1562 Arthur Road, Geraldton WA 6530", phone: "0409 981 026", lat: -28.8346566, lng: 114.7321136, state: "WA"},
      {id: 623, company: "Integrated Fuel Services", address: "Perth WA 6000", phone: "08 9434 7000", lat: -31.9525739, lng: 115.8610488, state: "WA"},
      {id: 665, company: "J & S Labour and Machinery", address: "40 Moorambine Street, Wedgefield WA 6721", phone: "08 9172 5313", lat: -20.3663216, lng: 118.5870289, state: "WA"},
      {id: 645, company: "Kip & Steve's Mechanical Repairs", address: "21 Currong Street, Esperance WA 6450", phone: "08 9071 2411", lat: -33.8355027, lng: 121.8958181, state: "WA"},
      {id: 690, company: "Perth Tanker Repairs", address: "30-32 Macedonia St, Naval Base WA 6165", phone: "08 9410 0222", lat: -32.2022035, lng: 115.7831976, state: "WA"},
      {id: 651, company: "Perth Tanker Repairs", address: "Naval Base WA 6165", phone: "08 9410 0222", lat: -32.1964799, lng: 115.798936, state: "WA"},
      {id: 606, company: "Petroleum Technologies Australia", address: "5 Kybo Street, Kalgoorlie WA 6430", phone: "08 9091 2321", lat: -30.7852563, lng: 121.4429398, state: "WA"},
      {id: 613, company: "Road Tank Repairs & Services WA", address: "Perth WA 6000", phone: "08 6166 3860", lat: -31.9525739, lng: 115.8610488, state: "WA"},
      {id: 691, company: "Road Tank Repairs & Services WA", address: "11 Camomile Way, Bibra Lake WA 6163", phone: "08 6166 3860", lat: -32.1084505, lng: 115.8198885, state: "WA"},
      {id: 644, company: "Stevemacs Bulk", address: "27-29 Glassford Road, Kewdale WA 6105", phone: "08 9352 2100", lat: -31.969669, lng: 115.9550175, state: "WA"},
      {id: 607, company: "WA Fuel Supplies", address: "Perth WA 6000", phone: "08 9943 8338", lat: -31.9525739, lng: 115.8610488, state: "WA"},
      {id: 609, company: "WA Transmech", address: "30-32 Macedonia Street, Naval Base WA 6165", phone: "08 8410 0857", lat: -32.2022035, lng: 115.7831976, state: "WA"},
      
      // NT Locations (4)
      {id: 820, company: "Haulmark Trailers Australia", address: "1 Mettham Road, Berrimah NT 828", phone: "08 8984 3533", lat: -12.4606551, lng: 130.9283392, state: "NT"},
      {id: 809, company: "RGM Maintenance Pty Ltd", address: "9 Matthew Hopkins Rd, Holtze NT 829", phone: "08 8983 0100", lat: -12.4549185, lng: 130.9838449, state: "NT"},
      {id: 811, company: "SWEL Pty Ltd", address: "50 Sargent Street, Alice Springs NT 870", phone: "08 8953 0369", lat: -23.6739621, lng: 133.8676851, state: "NT"},
      {id: 801, company: "Tanker Repairs Australia", address: "26 McKinnon Rd, Pinelands NT 829", phone: "08 8932 1328", lat: -12.4549857, lng: 130.9620088, state: "NT"},
      
      // TAS Locations (5)
      {id: 704, company: "AJL Heavy Equipment", address: "1-3 Massy-Greene Drive, South Burnie TAS 7320", phone: "03 6430 2777", lat: -41.0674275, lng: 145.9239546, state: "TAS"},
      {id: 703, company: "AJL Heavy Equipment", address: "South Burnie TAS 7320", phone: "03 6430 2777", lat: -41.0701328, lng: 145.8962992, state: "TAS"},
      {id: 701, company: "Kent Engineering", address: "153 Stoney Rise Road, Devonport TAS 7310", phone: "03 6424 9233", lat: -41.1926208, lng: 146.3297592, state: "TAS"},
      {id: 710, company: "Midland Truck & Bus", address: "42 Crooked Billet Drive, Bridgewater TAS 7030", phone: "03 6263 4333", lat: -42.7210713, lng: 147.2344207, state: "TAS"},
      {id: 702, company: "Wiggies Radiators", address: "18-22 Hillcrest Road, Devonport TAS 7310", phone: "03 6424 7292", lat: -41.1828568, lng: 146.3302493, state: "TAS"}
    ];

    // Alpine.js component
    function ailFinder() {
      return {
        activeTab: 'map',
        selectedState: 'all',
        searchText: '',
        filteredLocations: [],
        selectedLocation: null,
        showAutocomplete: false,
        autocompleteItems: [],
        // Global variables for Near Me functionality
        nearMeSearchText: '',
        showNearMeAutocomplete: false,
        nearMeAutocompleteItems: [],
        nearMeSelectedIndex: -1,
        userLocation: null,
        searchRadius: 50,
        gettingLocation: false,
        nearMeResults: [],
        geocoder: null,

        init() {
          // Store reference to this component globally
          ailFinderComponent = this;
          
          ailData = rawAilData;
          this.filteredLocations = [...ailData];
          
          // Initialize map after a short delay to ensure DOM is ready
          setTimeout(() => {
            if (window.google && window.google.maps && !mapInitialized) {
              initMap();
            }
          }, 500);
          
          // Backup initialization - try again if map isn't ready
          setTimeout(() => {
            if (window.google && window.google.maps && mapInitialized && markers.length === 0) {
              loadMarkers();
            }
            // Initialize geocoder when Google Maps is ready
            if (window.google && window.google.maps) {
              this.geocoder = new google.maps.Geocoder();
            }
          }, 2000);
        },

        handleSearchInput() {
          this.filterLocations();
          this.updateAutocomplete();
          this.selectedIndex = -1;
        },

        handleKeyDown(event) {
          if (!this.showAutocomplete || this.autocompleteItems.length === 0) {
            if (event.key === 'Enter') {
              this.performSearch();
            }
            return;
          }

          switch (event.key) {
            case 'ArrowDown':
              event.preventDefault();
              this.selectedIndex = Math.min(this.selectedIndex + 1, this.autocompleteItems.length - 1);
              break;
            case 'ArrowUp':
              event.preventDefault();
              this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
              break;
            case 'Enter':
              event.preventDefault();
              if (this.selectedIndex >= 0) {
                this.selectAutocompleteItem(this.autocompleteItems[this.selectedIndex]);
              } else {
                this.performSearch();
              }
              break;
            case 'Escape':
              this.showAutocomplete = false;
              this.selectedIndex = -1;
              break;
          }
        },

        updateAutocomplete() {
          if (!this.searchText || this.searchText.length < 2) {
            this.autocompleteItems = [];
            return;
          }

          const searchLower = this.searchText.toLowerCase();
          this.autocompleteItems = ailData.filter(location => 
            location.company.toLowerCase().includes(searchLower) ||
            location.address.toLowerCase().includes(searchLower)
          ).slice(0, 8);
        },

        selectAutocompleteItem(item) {
          this.searchText = item.company;
          this.showAutocomplete = false;
          this.selectedIndex = -1;
          this.filterLocations();
        },

        performSearch() {
          this.showAutocomplete = false;
          this.selectedIndex = -1;
          this.filterLocations();
        },

        filterLocations() {
          this.filteredLocations = ailData.filter(location => {
            const matchesSearch = !this.searchText || 
              location.company.toLowerCase().includes(this.searchText.toLowerCase()) ||
              location.address.toLowerCase().includes(this.searchText.toLowerCase());
            const matchesState = this.selectedState === 'all' || location.state === this.selectedState;
            return matchesSearch && matchesState;
          });
          
          // Update map markers if map is active
          if (this.activeTab === 'map' && mapInitialized) {
            filterMapMarkers();
            
            // FIXED: Only trigger smart zoom for search, not state changes
            if (this.selectedState === 'all') {
              setTimeout(() => {
                this.smartZoomToResults();
              }, 200);
            }
          }
        },

        smartZoomToResults() {
          if (!mapInitialized || this.filteredLocations.length === 0) return;
          
          // If 1 result, zoom to that specific location
          if (this.filteredLocations.length === 1) {
            this.zoomToLocation(this.filteredLocations[0]);
            return;
          }
          
          // If 2-10 results, fit bounds to show all results
          if (this.filteredLocations.length >= 2 && this.filteredLocations.length <= 10) {
            this.fitBoundsToResults();
            return;
          }
          
          // Default: show all of Australia for many results
          if (this.filteredLocations.length > 10) {
            this.fitMapToAustralia();
          }
        },

        fitBoundsToResults() {
          if (!mapInitialized || this.filteredLocations.length === 0) return;
          
          const bounds = new google.maps.LatLngBounds();
          
          this.filteredLocations.forEach(location => {
            bounds.extend(new google.maps.LatLng(location.lat, location.lng));
          });
          
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            map.fitBounds(bounds);
            
            setTimeout(() => {
              const currentZoom = map.getZoom();
              if (currentZoom > 12) {
                map.setZoom(Math.min(currentZoom - 0.5, 14));
              } else if (currentZoom > 8) {
                map.setZoom(currentZoom - 0.3);
              }
            }, 300);
          }, 100);
        },

        // FIXED: Improved state change handling
        handleStateChange() {
          console.log('State changed to:', this.selectedState);
          
          // Filter locations first
          this.filterLocations();
          
          // Handle map zooming for state changes
          if (mapInitialized) {
            if (this.selectedState !== 'all') {
              console.log('Zooming to state:', this.selectedState);
              // Use longer delay to ensure filtering is complete
              setTimeout(() => {
                this.zoomToState(this.selectedState);
              }, 400);
            } else {
              console.log('Zooming to Australia');
              setTimeout(() => {
                this.fitMapToAustralia();
              }, 400);
            }
          }
        },

        clearFilters() {
          this.searchText = '';
          this.selectedState = 'all';
          this.showAutocomplete = false;
          this.autocompleteItems = [];
          this.selectedIndex = -1;
          this.clearNearMeSearch();
          this.filterLocations();
          
          if (mapInitialized) {
            setTimeout(() => {
              this.fitMapToAustralia();
            }, 300);
          }
        },

        // Near Me Search Functions
        handleNearMeInput() {
          this.updateNearMeAutocomplete();
          this.nearMeSelectedIndex = -1;
        },

        handleNearMeKeyDown(event) {
          if (!this.showNearMeAutocomplete || this.nearMeAutocompleteItems.length === 0) {
            if (event.key === 'Enter') {
              this.performNearMeGeocoding();
            }
            return;
          }

          switch (event.key) {
            case 'ArrowDown':
              event.preventDefault();
              this.nearMeSelectedIndex = Math.min(this.nearMeSelectedIndex + 1, this.nearMeAutocompleteItems.length - 1);
              break;
            case 'ArrowUp':
              event.preventDefault();
              this.nearMeSelectedIndex = Math.max(this.nearMeSelectedIndex - 1, -1);
              break;
            case 'Enter':
              event.preventDefault();
              if (this.nearMeSelectedIndex >= 0) {
                this.selectNearMeItem(this.nearMeAutocompleteItems[this.nearMeSelectedIndex]);
              } else {
                this.performNearMeGeocoding();
              }
              break;
            case 'Escape':
              this.showNearMeAutocomplete = false;
              this.nearMeSelectedIndex = -1;
              break;
          }
        },

        updateNearMeAutocomplete() {
          if (!this.nearMeSearchText || this.nearMeSearchText.length < 3) {
            this.nearMeAutocompleteItems = [];
            return;
          }

          // Use Google Places Autocomplete API for location suggestions
          if (window.google && window.google.maps && window.google.maps.places) {
            const service = new google.maps.places.AutocompleteService();
            service.getPlacePredictions({
              input: this.nearMeSearchText,
              componentRestrictions: { country: 'AU' },
              types: ['geocode']
            }, (predictions, status) => {
              if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                this.nearMeAutocompleteItems = predictions;
              } else {
                this.nearMeAutocompleteItems = [];
              }
            });
          }
        },

        selectNearMeItem(item) {
          this.nearMeSearchText = item.description;
          this.showNearMeAutocomplete = false;
          this.nearMeSelectedIndex = -1;
          this.performNearMeGeocoding();
        },

        getCurrentLocation() {
          if (!navigator.geolocation) {
            alert('Geolocation is not supported by this browser.');
            return;
          }

          this.gettingLocation = true;

          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              this.nearMeSearchText = 'Your current location';
              this.gettingLocation = false;
              this.performNearMeSearch();
            },
            (error) => {
              this.gettingLocation = false;
              console.error('Error getting location:', error);
              alert('Unable to get your location. Please enter your address manually.');
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 300000 // 5 minutes
            }
          );
        },

        performNearMeGeocoding() {
          if (!this.geocoder || !this.nearMeSearchText) return;

          this.geocoder.geocode({
            address: this.nearMeSearchText,
            componentRestrictions: { country: 'AU' }
          }, (results, status) => {
            if (status === 'OK' && results[0]) {
              this.userLocation = {
                lat: results[0].geometry.location.lat(),
                lng: results[0].geometry.location.lng()
              };
              this.performNearMeSearch();
            } else {
              alert('Location not found. Please try a different address.');
            }
          });
        },

        performNearMeSearch() {
          if (!this.userLocation) return;

          // Calculate distances and sort by proximity
          const locationsWithDistance = ailData.map(location => {
            const distance = this.calculateDistance(
              this.userLocation.lat,
              this.userLocation.lng,
              location.lat,
              location.lng
            );
            return { ...location, distance };
          });

          // Filter by radius and sort by distance
          this.nearMeResults = locationsWithDistance
            .filter(location => location.distance <= this.searchRadius)
            .sort((a, b) => a.distance - b.distance);

          // Update filtered locations to show near me results
          this.filteredLocations = this.nearMeResults;

          // Update map
          if (mapInitialized) {
            filterMapMarkers();
            this.zoomToNearMeResults();
          }

          // Switch to map tab to show results
          this.activeTab = 'map';
        },

        calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371; // Earth's radius in kilometers
          const dLat = this.degToRad(lat2 - lat1);
          const dLon = this.degToRad(lon2 - lon1);
          const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.degToRad(lat1)) * Math.cos(this.degToRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          return R * c;
        },

        degToRad(deg) {
          return deg * (Math.PI/180);
        },

        zoomToNearMeResults() {
          if (!mapInitialized || !this.userLocation) return;

          if (this.nearMeResults.length === 0) {
            // Just center on user location if no results
            map.setCenter(this.userLocation);
            map.setZoom(10);
            return;
          }

          // Create bounds including user location and all nearby AILs
          const bounds = new google.maps.LatLngBounds();
          bounds.extend(new google.maps.LatLng(this.userLocation.lat, this.userLocation.lng));
          
          this.nearMeResults.forEach(location => {
            bounds.extend(new google.maps.LatLng(location.lat, location.lng));
          });

          setTimeout(() => {
            map.fitBounds(bounds, {
              top: 80,
              right: 80,
              bottom: 80,
              left: 80
            });

            // Limit maximum zoom for near me results
            setTimeout(() => {
              const currentZoom = map.getZoom();
              if (currentZoom > 14) {
                map.setZoom(14);
              }
            }, 500);
          }, 200);
        },

        clearNearMeSearch() {
          this.nearMeSearchText = '';
          this.showNearMeAutocomplete = false;
          this.nearMeAutocompleteItems = [];
          this.nearMeSelectedIndex = -1;
          this.userLocation = null;
          this.nearMeResults = [];
          this.gettingLocation = false;
          
          // Reset to show all locations
          this.filteredLocations = ailData.filter(location => {
            const matchesSearch = !this.searchText || 
              location.company.toLowerCase().includes(this.searchText.toLowerCase()) ||
              location.address.toLowerCase().includes(this.searchText.toLowerCase());
            const matchesState = this.selectedState === 'all' || location.state === this.selectedState;
            return matchesSearch && matchesState;
          });

          if (mapInitialized) {
            filterMapMarkers();
          }
        },

        setActiveTab(tab) {
          this.activeTab = tab;
          
          if (tab === 'map' && mapInitialized) {
            setTimeout(() => {
              google.maps.event.trigger(map, 'resize');
              
              // Preserve current zoom state when switching to map tab
              if (this.selectedState !== 'all') {
                setTimeout(() => {
                  this.zoomToState(this.selectedState);
                }, 200);
              } else {
                this.fitMapToAustralia();
              }
            }, 100);
          }
        },

        viewOnMap(location) {
          this.activeTab = 'map';
          this.selectedLocation = location;
          
          if (mapInitialized) {
            setTimeout(() => {
              this.zoomToLocation(location);
            }, 200);
          }
        },

        zoomToLocation(location) {
          if (!mapInitialized) return;
          
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            map.setCenter({ lat: location.lat, lng: location.lng });
            map.setZoom(12);
            this.selectedLocation = location;
          }, 100);
        },

        // FIXED: Much improved state zooming function with smoother zoom graduations
        zoomToState(state) {
          console.log('zoomToState called for:', state);
          if (!mapInitialized || !stateBounds[state]) {
            console.log('Map not ready or state bounds not found');
            return;
          }
          
          const bounds = stateBounds[state];
          console.log('Using bounds:', bounds);
          
          // Ensure map is properly sized before fitting bounds
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            
            // Create the bounds object
            const mapBounds = new google.maps.LatLngBounds(
              new google.maps.LatLng(bounds.south, bounds.west),
              new google.maps.LatLng(bounds.north, bounds.east)
            );
            
            // Fit bounds with proper padding
            map.fitBounds(mapBounds, {
              top: 50,
              right: 50,
              bottom: 50,
              left: 50
            });
            
            console.log('Fitted bounds for state:', state);
            
            // FIXED: Smoother zoom graduations with quarter steps
            setTimeout(() => {
              const currentZoom = map.getZoom();
              console.log('Current zoom after fitBounds:', currentZoom);
              
              // More granular zoom control with quarter steps
              let targetZoom = currentZoom;
              
              if (state === 'WA' || state === 'NT') {
                // Very large states - keep zoomed out
                targetZoom = Math.min(currentZoom, 5.75);
              } else if (state === 'QLD') {
                // Large state
                targetZoom = Math.min(currentZoom, 6.25);
              } else if (state === 'NSW' || state === 'VIC' || state === 'SA') {
                // Medium states
                targetZoom = Math.min(currentZoom, 6.75);
              } else if (state === 'TAS') {
                // Smallest state - can zoom in more
                targetZoom = Math.min(currentZoom, 7.5);
              }
              
              // Apply smooth zoom transition
              map.setZoom(targetZoom);
            }, 500);
          }, 200);
        },

        fitMapToAustralia() {
          if (!mapInitialized) return;
          
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            const bounds = new google.maps.LatLngBounds(
              new google.maps.LatLng(australiaBounds.south, australiaBounds.west),
              new google.maps.LatLng(australiaBounds.north, australiaBounds.east)
            );
            
            map.fitBounds(bounds, {
              top: 20,
              right: 20,
              bottom: 20,
              left: 20
            });
            
            // FIXED: Smoother zoom for Australia view
            setTimeout(() => {
              const currentZoom = map.getZoom();
              // More precise zoom level for Australia overview
              const targetZoom = Math.min(currentZoom, 5.25);
              map.setZoom(targetZoom);
            }, 300);
          }, 100);
        }, 7) {
                  map.setZoom(Math.min(currentZoom, 7));
                }
              } else if (state === 'TAS') {
                if (currentZoom > 8) {
                  map.setZoom(Math.min(currentZoom, 8));
                }
              }
            }, 500);
          }, 200);
        },

        fitMapToAustralia() {
          if (!mapInitialized) return;
          
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            const bounds = new google.maps.LatLngBounds(
              new google.maps.LatLng(australiaBounds.south, australiaBounds.west),
              new google.maps.LatLng(australiaBounds.north, australiaBounds.east)
            );
            
            map.fitBounds(bounds, {
              top: 20,
              right: 20,
              bottom: 20,
              left: 20
            });
            
            setTimeout(() => {
              const currentZoom = map.getZoom();
              if (currentZoom > 5) {
                map.setZoom(Math.min(currentZoom, 5.5));
              }
            }, 300);
          }, 100);
        },
      }
    }

    // Google Maps initialization with smoother zoom controls
    function initMap() {
      try {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 5.25,
          center: { lat: -25.2744, lng: 133.7751 },
          mapTypeId: 'roadmap',
          zoomControl: true,
          zoomControlOptions: {
            position: google.maps.ControlPosition.RIGHT_CENTER
          },
          // FIXED: Enable smoother zoom with smaller increments
          gestureHandling: 'greedy',
          scrollwheel: true,
          styles: [
            {
              featureType: "poi",
              elementType: "labels",
              stylers: [{ visibility: "off" }]
            }
          ]
        });

        mapInitialized = true;
        
        loadMarkers();
        
        setTimeout(() => {
          const bounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(australiaBounds.south, australiaBounds.west),
            new google.maps.LatLng(australiaBounds.north, australiaBounds.east)
          );
          map.fitBounds(bounds);
        }, 100);
        
        map.addListener('click', function() {
          console.log('🗺️ Map clicked - closing popup');
          if (ailFinderComponent && ailFinderComponent.selectedLocation) {
            ailFinderComponent.selectedLocation = null;
          }
        });
        
      } catch (error) {
        console.error('Error initializing map:', error);
      }
    }

    function loadMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      const locationGroups = {};
      
      ailData.forEach(ail => {
        const key = `${ail.lat.toFixed(6)},${ail.lng.toFixed(6)}`;
        if (!locationGroups[key]) {
          locationGroups[key] = [];
        }
        locationGroups[key].push(ail);
      });

      Object.values(locationGroups).forEach(ailsAtLocation => {
        const primaryAIL = ailsAtLocation[0];
        const isCluster = ailsAtLocation.length > 1;
        
        try {
          const marker = new google.maps.Marker({
            position: { lat: primaryAIL.lat, lng: primaryAIL.lng },
            map: map,
            title: isCluster 
              ? `${ailsAtLocation.length} AILs at this location` 
              : primaryAIL.company,
            icon: {
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="14" cy="14" r="12" fill="${isCluster ? '#dc2626' : '#2563eb'}" stroke="white" stroke-width="2"/>
                  <circle cx="14" cy="14" r="6" fill="white"/>
                  ${isCluster ? `<text x="14" y="18" text-anchor="middle" fill="${isCluster ? '#dc2626' : '#2563eb'}" font-size="8" font-weight="bold">${ailsAtLocation.length}</text>` : ''}
                </svg>
              `),
              scaledSize: new google.maps.Size(isCluster ? 28 : 24, isCluster ? 28 : 24),
              anchor: new google.maps.Point(isCluster ? 14 : 12, isCluster ? 14 : 12)
            }
          });

          marker.ailsAtLocation = ailsAtLocation;

          marker.addListener("click", () => {
            console.log('🖱️ Marker clicked for:', primaryAIL.company);
            
            if (ailFinderComponent) {
              console.log('✅ Setting selectedLocation via global reference');
              
              // Check if this is a cluster or single AIL
              if (isCluster) {
                // For clusters, create a special cluster object
                ailFinderComponent.selectedLocation = {
                  ...primaryAIL,
                  isCluster: true,
                  ailsAtLocation: ailsAtLocation,
                  company: `${ailsAtLocation.length} AILs at this location`,
                  address: primaryAIL.address
                };
              } else {
                // For single AILs, use the AIL directly
                ailFinderComponent.selectedLocation = {
                  ...primaryAIL,
                  isCluster: false
                };
              }
              
              ailFinderComponent.$nextTick(() => {
                console.log('✅ Alpine UI updated, popup should be visible');
              });
            } else {
              console.error('❌ Global ailFinderComponent not available');
            }
          });

          markers.push(marker);
        } catch (error) {
          console.error(`Error creating marker for ${primaryAIL.company}:`, error);
        }
      });
    }

    function filterMapMarkers() {
      if (!mapInitialized) return;
      
      const appComponent = document.querySelector('[x-data]').__x.$data;
      if (!appComponent) return;
      
      markers.forEach(marker => {
        const shouldShow = marker.ailsAtLocation.some(ail => {
          const matchesSearch = !appComponent.searchText || 
            ail.company.toLowerCase().includes(appComponent.searchText.toLowerCase()) ||
            ail.address.toLowerCase().includes(appComponent.searchText.toLowerCase());
          const matchesState = appComponent.selectedState === 'all' || ail.state === appComponent.selectedState;
          
          return matchesSearch && matchesState;
        });
        
        marker.setVisible(shouldShow);
      });
    }

    window.initMap = initMap;

    document.addEventListener('DOMContentLoaded', function() {
      if (window.google && window.google.maps && !mapInitialized) {
        setTimeout(initMap, 1000);
      }
    });
  </script>
  
  <!-- Load Google Maps with callback and Places library for autocomplete -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPnUqhxYzzgoRJ32Rh6-bg5wmKuXtBmKI&callback=initMap&libraries=geometry,places">
  </script>
</body>
</html>
