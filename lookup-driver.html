<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Lookup – Safe Freight Program</title>

  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    [x-cloak] { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Injected Header -->
  <div id="header"></div>

  <!-- Main Section -->
  <main class="max-w-4xl mx-auto px-4 py-12" x-data="driverLookup()" x-init="init()">
    <h1 class="text-3xl font-bold text-blue-800 text-center mb-8">Driver Lookup</h1>

    <form @submit.prevent="search" class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
      <input type="text" x-model="query" placeholder="Enter Driver ID or Licence Number"
        class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-300" />
      <button type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded transition">Search</button>
    </form>

    <template x-if="resultFound">
      <div class="bg-white rounded shadow p-6 border border-gray-200">
        <h2 class="text-xl font-semibold text-green-700 mb-4">Driver Found</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <template x-for="(value, key) in result" :key="key">
            <div>
              <dt class="text-gray-600 text-sm" x-text="formatKey(key)"></dt>
              <dd class="text-gray-900 font-medium" x-text="value || '—'"></dd>
            </div>
          </template>
        </div>
      </div>
    </template>

    <template x-if="resultNotFound">
      <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 rounded p-4 text-center">
        No driver found for that ID or licence number.
      </div>
    </template>

    <template x-if="error">
      <div class="bg-red-100 border border-red-300 text-red-800 rounded p-4 text-center mt-4" x-text="error"></div>
    </template>
  </main>

  <!-- Injected Footer -->
  <div id="footer"></div>

  <!-- Header/Footer + Delayed Alpine Load -->
  <script>
    async function include(id, file) {
      const res = await fetch(file);
      if (!res.ok) throw new Error(`${file} not found`);
      document.getElementById(id).innerHTML = await res.text();
    }

    async function initPage() {
      await include("header", "components/header.html");
      await include("footer", "components/footer.html");

      const alpine = document.createElement('script');
      alpine.src = 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js';
      alpine.defer = true;
      document.body.appendChild(alpine);
    }

    initPage();
  </script>

  <!-- Driver Lookup Logic -->
  <script>
    function driverLookup() {
      return {
        query: '',
        result: {},
        resultFound: false,
        resultNotFound: false,
        error: '',

        init() {
          const url = new URLSearchParams(window.location.search);
          const id = url.get('id');
          if (id) {
            this.query = id;
            this.search();
          }
        },

        async search() {
          this.resultFound = false;
          this.resultNotFound = false;
          this.error = '';
          try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbyltST20zF4DC9CJuHZOLLGkMxdknfzqZu5dAzES-Wj4z6WL7-uIdUCIWmn2YuUrQL6/exec?type=driver&id=' + encodeURIComponent(this.query));
            const data = await response.json();
            if (data.success) {
              this.result = data.result;
              this.resultFound = true;
            } else {
              this.resultNotFound = true;
            }
          } catch (err) {
            this.error = 'Something went wrong. Please try again later.';
            console.error(err);
          }
        },

        formatKey(key) {
          return key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
        }
      }
    }
  </script>

</body>
</html>
