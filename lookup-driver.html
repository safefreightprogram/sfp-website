function exportAllSlidesAsPNGs() {
  console.log('Starting PNG export process...');
  
  const sheet = SpreadsheetApp.openById('1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ').getSheetByName('Sheet 1');
  const data = sheet.getDataRange().getValues();

  // Updated to use your correct Cards folder
  const cardsFolder = DriveApp.getFolderById('1-xjVXOzWwWAF8BvQ3HzPF79X2JYeXWWa');

  let successCount = 0;
  let errorCount = 0;

  // Process each row (skip header row)
  for (let i = 1; i < data.length; i++) {
    const driverId = data[i][0];              // Column A - ID
    const presentationId = data[i][7];        // Column H - Slide File ID
    
    // Skip if no presentation ID
    if (!presentationId || presentationId === '') {
      console.log(`Skipping row ${i + 1}: No presentation ID for ${driverId}`);
      continue;
    }

    try {
      // Add delay to avoid rate limiting
      if (i > 1) Utilities.sleep(500);
      
      console.log(`Processing ${driverId} (row ${i + 1})...`);
      
      // Get the presentation
      const presentation = Slides.Presentations.get(presentationId);
      
      // Check if slides exist
      if (!presentation.slides || presentation.slides.length === 0) {
        console.log(`No slides found for presentation ${presentationId}`);
        errorCount++;
        continue;
      }
      
      const slideId = presentation.slides[0].objectId;

      // Get thumbnail
      const thumbnail = Slides.Presentations.Pages.getThumbnail(
        presentationId,
        slideId,
        {
          'thumbnailProperties.thumbnailSize': 'LARGE',
          'thumbnailProperties.mimeType': 'PNG'
        }
      );

      // Fetch the image and create file
      const imageBlob = UrlFetchApp.fetch(thumbnail.contentUrl)
        .getBlob()
        .setName(`${driverId}-card.png`);
      
      // Delete existing file if it exists
      const existingFiles = cardsFolder.getFilesByName(`${driverId}-card.png`);
      while (existingFiles.hasNext()) {
        existingFiles.next().setTrashed(true);
      }
      
      // Create new file
      const file = cardsFolder.createFile(imageBlob);
      
      // Make file publicly viewable
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      
      // Update spreadsheet with direct access URL in Column I (Card PNG Link)
      const directAccessUrl = `https://drive.google.com/uc?export=view&id=${file.getId()}`;
      sheet.getRange(i + 1, 9).setValue(directAccessUrl);
      
      successCount++;
      console.log(`Successfully exported ${driverId}-card.png with direct access URL`);

    } catch (e) {
      errorCount++;
      console.error(`Error on row ${i + 1} (Driver: ${driverId}, Presentation: ${presentationId}): ${e.message}`);
      
      // Optional: Write error status to a status column
      // sheet.getRange(i + 1, 12).setValue(`Error: ${e.message}`);
    }
  }
  
  console.log(`PNG export completed. Success: ${successCount}, Errors: ${errorCount}`);
}

// Test function for a single row
function testSingleExport() {
  console.log('Testing single PNG export...');
  
  const sheet = SpreadsheetApp.openById('1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ').getSheetByName('Sheet 1');
  const data = sheet.getDataRange().getValues();
  
  // Test with first data row (row 2 in sheet, index 1 in array)
  const driverId = data[1][0];
  const presentationId = data[1][7];
  
  console.log(`Testing with Driver ID: ${driverId}, Presentation ID: ${presentationId}`);
  
  if (!presentationId) {
    console.log('No presentation ID found in test row');
    return;
  }
  
  // Updated to use your correct Cards folder
  const cardsFolder = DriveApp.getFolderById('1-xjVXOzWwWAF8BvQ3HzPF79X2JYeXWWa');
  
  try {
    const presentation = Slides.Presentations.get(presentationId);
    const slideId = presentation.slides[0].objectId;
    
    const thumbnail = Slides.Presentations.Pages.getThumbnail(
      presentationId,
      slideId,
      {
        'thumbnailProperties.thumbnailSize': 'LARGE',
        'thumbnailProperties.mimeType': 'PNG'
      }
    );
    
    const imageBlob = UrlFetchApp.fetch(thumbnail.contentUrl)
      .getBlob()
      .setName(`${driverId}-card-test.png`);
    
    const file = cardsFolder.createFile(imageBlob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const directAccessUrl = `https://drive.google.com/uc?export=view&id=${file.getId()}`;
    console.log(`Test successful! Direct access URL: ${directAccessUrl}`);
    
  } catch (e) {
    console.error(`Test failed: ${e.message}`);
  }
}

// Function to update QR codes to point to lookup page
function updateQRCodeURLs() {
  console.log('Updating QR codes to point to lookup page...');
  
  const sheet = SpreadsheetApp.openById('1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ').getSheetByName('Sheet 1');
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  const idCol = headers.indexOf("ID");
  const qrUrlCol = headers.indexOf("QR Code URL");
  
  if (idCol === -1 || qrUrlCol === -1) {
    console.log("Could not find ID or QR Code URL columns");
    return;
  }
  
  let updateCount = 0;
  
  for (let i = 1; i < data.length; i++) {
    const driverId = data[i][idCol];
    if (driverId) {
      // Create the lookup URL that will show the driver card
      const lookupUrl = `https://safefreightprogram.com/lookup-driver?id=${driverId}`;
      
      // Generate QR code URL pointing to the lookup page
      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(lookupUrl)}&size=150x150`;
      
      // Update the QR Code URL column
      sheet.getRange(i + 1, qrUrlCol + 1).setValue(qrCodeUrl);
      
      updateCount++;
      console.log(`Updated QR code for ${driverId}: ${lookupUrl}`);
    }
  }
  
  console.log(`✅ Updated ${updateCount} QR code URLs to point to lookup page`);
}

// Alternative: Point QR codes directly to PNG files
function updateQRCodesToPNGs() {
  console.log('Updating QR codes to point directly to PNG files...');
  
  const sheet = SpreadsheetApp.openById('1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ').getSheetByName('Sheet 1');
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  const idCol = headers.indexOf("ID");
  const qrUrlCol = headers.indexOf("QR Code URL");
  const pngLinkCol = headers.indexOf("Card PNG Link");
  
  if (idCol === -1 || qrUrlCol === -1 || pngLinkCol === -1) {
    console.log("Could not find required columns");
    return;
  }
  
  let updateCount = 0;
  
  for (let i = 1; i < data.length; i++) {
    const driverId = data[i][idCol];
    const pngLink = data[i][pngLinkCol];
    
    if (driverId && pngLink) {
      // Generate QR code URL pointing directly to the PNG file
      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(pngLink)}&size=150x150`;
      
      // Update the QR Code URL column
      sheet.getRange(i + 1, qrUrlCol + 1).setValue(qrCodeUrl);
      
      updateCount++;
      console.log(`Updated QR code for ${driverId} to point to PNG`);
    }
  }
  
  console.log(`✅ Updated ${updateCount} QR code URLs to point to PNG files`);
}

// Function to update existing PNG links to direct access format
function updateExistingPNGLinks() {
  console.log('Updating existing PNG links to direct access format...');
  
  const sheet = SpreadsheetApp.openById('1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ').getSheetByName('Sheet 1');
  const data = sheet.getDataRange().getValues();
  
  let updateCount = 0;
  
  for (let i = 1; i < data.length; i++) {
    const pngLink = data[i][8]; // Column I (Card PNG Link)
    
    if (pngLink && pngLink.includes('drive.google.com/file/d/')) {
      const match = pngLink.match(/\/file\/d\/([a-zA-Z0-9-_]+)/);
      if (match) {
        const fileId = match[1];
        const newUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
        sheet.getRange(i + 1, 9).setValue(newUrl);
        updateCount++;
        console.log(`Updated link for row ${i + 1}: ${newUrl}`);
      }
    }
  }
  
  console.log(`Updated ${updateCount} PNG links to direct access format`);
}

// Test function to check current QR code URLs
function checkCurrentQRCodes() {
  console.log('Checking current QR code URLs...');
  
  const sheet = SpreadsheetApp.openById('1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ').getSheetByName('Sheet 1');
  const data = sheet.getDataRange().getValues();
  
  console.log("Current QR code URLs:");
  for (let i = 1; i < Math.min(5, data.length); i++) {
    const driverId = data[i][0];
    const qrUrl = data[i][5]; // QR Code URL column
    console.log(`${driverId}: ${qrUrl}`);
  }
}

// Function to set up daily automation
function setupDailyAutomation() {
  // Delete existing triggers for this function
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'exportAllSlidesAsPNGs') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // Create new daily trigger at 9 AM
  ScriptApp.newTrigger('exportAllSlidesAsPNGs')
    .timeBased()
    .everyDays(1)
    .atHour(9)
    .create();
    
  console.log('Daily trigger created for 9 AM');
}

// Function to set up weekly automation
function setupWeeklyAutomation() {
  // Delete existing triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'exportAllSlidesAsPNGs') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // Create weekly trigger (Mondays at 9 AM)
  ScriptApp.newTrigger('exportAllSlidesAsPNGs')
    .timeBased()
    .everyWeeks(1)
    .onWeekDay(ScriptApp.WeekDay.MONDAY)
    .atHour(9)
    .create();
    
  console.log('Weekly trigger created for Mondays at 9 AM');
}

// Function to clear all PNG links (useful for testing)
function clearPNGLinks() {
  const sheet = SpreadsheetApp.openById('1-kNJDzQVo9jfxSB25bgHRcfD3PHmaJyqsgSQ36TllRQ').getSheetByName('Sheet 1');
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    sheet.getRange(i + 1, 9).setValue(''); // Clear Column I
  }
  
  console.log('PNG links cleared');
}
