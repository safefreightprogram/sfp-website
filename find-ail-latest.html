<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Find an AIL – Safe Freight Program</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    /* Enhanced animations and styles */
    @keyframes pulse-dot {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .pulse-dot { animation: pulse-dot 1.8s infinite; }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    @keyframes slideInLeft {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutLeft {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(-100%); opacity: 0; }
    }
    
    @keyframes fadeInUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .slide-in-right { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .slide-out-right { animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .slide-in-left { animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .slide-out-left { animation: slideOutLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
    
    /* Glass morphism effects */
    .glass {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .glass-dark {
      backdrop-filter: blur(20px);
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Enhanced focus states */
    .focus-ring:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }
    
    /* Smooth hover transitions */
    .hover-lift {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    /* Enhanced scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Mobile responsive improvements */
    @media (max-width: 768px) {
      .mobile-full {
        width: calc(100vw - 2rem);
        left: 1rem;
        right: 1rem;
      }
      
      .mobile-bottom {
        position: fixed;
        bottom: 1rem;
        left: 1rem;
        right: 1rem;
        top: auto;
      }
    }
    
    /* Loading animation enhancement */
    .loading-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Map container optimization */
    #map {
      width: 100%;
      height: 100vh;
      position: relative;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* State badge improvements */
    .state-badge {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    /* Quick action buttons */
    .quick-action {
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .quick-action::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .quick-action:hover::before {
      left: 100%;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans overflow-hidden">
  <!-- Enhanced Header Component -->
  <header class="bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 text-white sticky top-0 z-50 shadow-xl border-b border-blue-700" x-data="{ open: false, showSearch: false }">
    <div class="max-w-7xl mx-auto p-4 flex justify-between items-center relative">
      <div class="flex items-center space-x-3">
        <a href="index.html" class="transition-all duration-300 transform hover:scale-105 focus-ring rounded-lg">
          <img src="SFP-Logo.png" alt="Safe Freight Program" class="h-8 w-auto filter drop-shadow-lg">
        </a>
      </div>
      
      <div class="flex items-center space-x-4">
        <button @click="showSearch = !showSearch" 
                class="p-2 rounded-xl hover:bg-white/10 transition-all duration-200 focus-ring" 
                aria-label="Toggle search">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m1.35-4.65a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
        
        <button @click="open = !open" 
                class="p-2 rounded-xl hover:bg-white/10 transition-all duration-200 focus-ring" 
                aria-label="Toggle menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
      
      <!-- Enhanced search dropdown -->
      <div x-show="showSearch" 
           @click.away="showSearch = false" 
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 scale-95"
           x-transition:enter-end="opacity-100 scale-100"
           x-transition:leave="transition ease-in duration-150"
           x-transition:leave-start="opacity-100 scale-100"
           x-transition:leave-end="opacity-0 scale-95"
           class="absolute top-full right-0 mt-2 glass rounded-xl shadow-2xl z-40 w-full sm:w-80">
        <div class="p-4">
          <form action="search.html" method="GET">
            <input type="search" 
                   name="q" 
                   placeholder="Search the site..." 
                   class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 placeholder-gray-500">
          </form>
        </div>
      </div>
      
      <!-- Enhanced navigation menu -->
      <div x-show="open" 
           @click.away="open = false" 
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 scale-95"
           x-transition:enter-end="opacity-100 scale-100"
           x-transition:leave="transition ease-in duration-150"
           x-transition:leave-start="opacity-100 scale-100"
           x-transition:leave-end="opacity-0 scale-95"
           class="absolute top-full right-0 mt-2 glass rounded-xl shadow-2xl z-50 overflow-hidden"
           :class="showSearch ? 'mr-80' : ''">
        <nav class="py-2">
          <a href="about.html" class="block px-6 py-3 hover:bg-white/10 transition-colors text-gray-100 hover:text-white">About</a>
          <a href="lookup-driver.html" class="block px-6 py-3 hover:bg-white/10 transition-colors text-gray-100 hover:text-white">Driver Lookup</a>
          <a href="lookup-vehicle.html" class="block px-6 py-3 hover:bg-white/10 transition-colors text-gray-100 hover:text-white">Vehicle Lookup</a>
          <a href="find-ail.html" class="block px-6 py-3 bg-white/20 text-white font-medium" data-active="find-ail">Find AIL</a>
          <a href="training.html" class="block px-6 py-3 hover:bg-white/10 transition-colors text-gray-100 hover:text-white">SFP Training</a>
          <a href="ail-login.html" class="block px-6 py-3 hover:bg-white/10 transition-colors text-gray-100 hover:text-white">AIL Portal</a>
          <a href="trainer-login.html" class="block px-6 py-3 hover:bg-white/10 transition-colors text-gray-100 hover:text-white">Trainer Login</a>
          <a href="contact.html" class="block px-6 py-3 hover:bg-white/10 transition-colors text-gray-100 hover:text-white">Contact</a>
          <a href="subscription.html" class="block px-6 py-3 hover:bg-white/10 transition-colors text-gray-100 hover:text-white">Subscribe</a>
        </nav>
      </div>
    </div>
  </header>

  <div class="relative w-full" x-data="enhancedAilFinder()" style="height: calc(100vh - 73px);">
    
    <!-- Full Screen Map Container -->
    <div id="map" class="w-full h-full absolute inset-0"></div>

    <!-- Enhanced Loading Overlay -->
    <div x-show="loading" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 glass-dark flex items-center justify-center z-50">
      <div class="glass rounded-3xl p-8 shadow-2xl max-w-sm mx-4 text-center">
        <div class="flex justify-center items-center space-x-2 mb-4">
          <div class="pulse-dot w-3 h-3 bg-blue-500 rounded-full"></div>
          <div class="pulse-dot w-3 h-3 bg-blue-500 rounded-full" style="animation-delay: 0.2s;"></div>
          <div class="pulse-dot w-3 h-3 bg-blue-500 rounded-full" style="animation-delay: 0.4s;"></div>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Finding AIL Locations</h3>
        <p class="text-gray-600 text-sm">Loading inspection facilities across Australia...</p>
      </div>
    </div>

    <!-- Enhanced List View Sidebar -->
    <div x-show="showList" 
         x-transition:enter="slide-in-left" 
         x-transition:leave="slide-out-left"
         class="absolute top-0 left-0 w-96 h-full glass shadow-2xl z-50 border-r border-gray-200">
      <div class="h-full flex flex-col">
        <!-- Enhanced sidebar header -->
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-xl font-bold text-gray-900">AIL Locations</h2>
            <button @click="showList = false" 
                    class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-xl transition-all duration-200 focus-ring">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <p class="text-gray-600 text-sm">
              <span x-text="filteredLocations.length" class="font-semibold text-blue-600"></span> 
              <span>locations found</span>
            </p>
            <span x-show="selectedState !== 'all'" 
                  class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium" 
                  x-text="selectedState"></span>
          </div>
        </div>
        
        <!-- Enhanced scrollable list -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">
          <div class="p-4 space-y-3">
            <template x-for="(location, index) in filteredLocations.slice(0, 50)" :key="location.id">
              <div @click="viewOnMap(location)" 
                   class="hover-lift glass rounded-xl p-4 cursor-pointer border border-gray-200 hover:border-blue-300 transition-all duration-200 group"
                   :class="selectedLocation?.id === location.id ? 'ring-2 ring-blue-500 border-blue-500' : ''">
                <div class="flex justify-between items-start mb-3">
                  <h3 class="font-semibold text-gray-900 text-sm leading-tight flex-1 pr-2 group-hover:text-blue-700 transition-colors" 
                      x-text="location.name"></h3>
                  <span class="state-badge text-xs px-2 py-1 rounded-md font-medium flex-shrink-0" 
                        x-text="location.state"></span>
                </div>
                
                <p class="text-gray-600 text-xs mb-3 leading-relaxed" x-text="getDisplayAddress(location)"></p>
                
                <div class="flex items-center justify-between">
                  <div x-show="hasNamedInspector(location)" class="text-xs text-gray-500">
                    <span class="text-gray-400">Inspector:</span>
                    <span class="font-medium text-gray-700 ml-1" x-text="location.inspector"></span>
                  </div>
                  <div class="flex space-x-2">
                    <button @click.stop="getDirections(location)"
                            class="quick-action bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-200 flex items-center shadow-sm hover:shadow-md">
                      <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m0 0L9 7"></path>
                      </svg>
                      Directions
                    </button>
                    <a :href="'tel:' + location.phone" 
                       @click.stop
                       class="quick-action bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-200 shadow-sm hover:shadow-md">
                      Call
                    </a>
                  </div>
                </div>
              </div>
            </template>
            
            <!-- Enhanced empty state -->
            <div x-show="filteredLocations.length === 0 && !loading" class="text-center py-12 fade-in-up">
              <div class="text-6xl mb-4 opacity-50">🔍</div>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">No locations found</h3>
              <p class="text-gray-500 text-sm mb-6 max-w-xs mx-auto">Try adjusting your search criteria or browse all available locations</p>
              <button @click="clearAllFilters()"
                      class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl text-sm font-medium transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Clear all filters
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Search Panel with better mobile positioning -->
    <div class="absolute top-6 z-40 transition-all duration-300" 
         :class="{ 'left-[25rem]': showList, 'left-6': !showList, 'mobile-full': true }">
      <div class="glass rounded-2xl shadow-2xl border border-gray-200 p-6 fade-in-up" 
           :class="showList ? 'w-80' : 'w-80'">
        
        <!-- Quick actions header -->
        <div class="flex items-center space-x-3 mb-6">
          <button @click="showList = !showList" 
                  class="p-3 hover:bg-gray-100 rounded-xl transition-all duration-200 flex-shrink-0 focus-ring group"
                  :class="showList ? 'bg-blue-50 text-blue-600' : 'text-gray-600'"
                  aria-label="Toggle list view">
            <svg class="w-5 h-5 transition-transform duration-200" 
                 :class="showList ? 'rotate-180' : ''"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
          </button>
          
          <!-- Enhanced search input -->
          <div class="flex-1 relative">
            <div class="relative">
              <input type="text" 
                     placeholder="Search by name, suburb, or state..."
                     class="w-full px-4 py-3 bg-gray-50 rounded-xl border-0 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white text-sm transition-all duration-200 pr-10"
                     x-model="searchQuery" 
                     @input="handleSearch" 
                     @keyup="handleSearch"
                     @keydown="handleKeydown($event)"
                     @focus="showSearchResults = true" 
                     @blur="setTimeout(() => showSearchResults = false, 200)" />
              <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" 
                   fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m1.35-4.65a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            
            <!-- Enhanced autosuggest dropdown -->
            <div x-show="showSearchResults && searchQuery.trim() !== '' && searchSuggestions.length > 0" 
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 class="absolute top-full left-0 right-0 glass border border-gray-200 rounded-xl shadow-xl mt-2 z-50 max-h-64 overflow-y-auto custom-scrollbar">
              <template x-for="(suggestion, index) in searchSuggestions.slice(0, 8)" :key="suggestion.id">
                <div @click="selectSuggestion(suggestion)" 
                     @mouseenter="highlightedIndex = index"
                     :class="highlightedIndex === index ? 'bg-blue-50 border-l-4 border-blue-500' : 'hover:bg-gray-50'"
                     class="px-4 py-3 cursor-pointer border-b border-gray-100 last:border-b-0 transition-all duration-150">
                  <div class="font-medium text-gray-900 text-sm" 
                       :class="highlightedIndex === index ? 'text-blue-900' : ''"
                       x-text="suggestion.name"></div>
                  <div class="text-xs mt-1 flex items-center"
                       :class="highlightedIndex === index ? 'text-blue-600' : 'text-gray-500'">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                    <span x-text="suggestion.suburb"></span>
                    <span x-show="suggestion.suburb && suggestion.state">, </span>
                    <span x-text="suggestion.state"></span>
                  </div>
                </div>
              </template>
              
              <div x-show="searchQuery.trim() !== '' && searchSuggestions.length === 0" 
                   class="px-4 py-3 text-gray-500 text-sm text-center">
                <div class="text-2xl mb-2">🔍</div>
                No locations found for "<span x-text="searchQuery" class="font-medium"></span>"
              </div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced location finder button -->
        <button @click="userLocation ? returnToAustraliaView() : findNearest()" 
                :disabled="loadingLocation"
                :class="userLocation ? 'bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800' : 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800'"
                class="w-full px-4 py-4 text-white rounded-xl font-medium transition-all duration-200 disabled:opacity-50 text-sm flex items-center justify-center mb-4 shadow-lg hover:shadow-xl transform hover:-translate-y-1 disabled:transform-none">
          <span x-show="!loadingLocation && !userLocation" class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            </svg>
            Find locations near me
          </span>
          <span x-show="!loadingLocation && userLocation" class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Show all Australia
          </span>
          <span x-show="loadingLocation" class="flex items-center">
            <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
            Finding your location...
          </span>
        </button>
        
        <!-- Enhanced filters section -->
        <div @mouseenter="showFilters = true" @mouseleave="showFilters = false" class="relative">
          <button @click="(selectedState !== 'all' || searchQuery.trim() !== '') ? clearAllFilters() : null" 
                  :class="(selectedState !== 'all' || searchQuery.trim() !== '') ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                  class="w-full px-4 py-3 rounded-xl font-medium transition-all duration-200 text-sm flex items-center justify-center group">
            <svg class="w-4 h-4 mr-2 transition-transform duration-200 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            <span x-show="selectedState === 'all' && searchQuery.trim() === ''">Filter by State</span>
            <span x-show="selectedState !== 'all' || searchQuery.trim() !== ''">Clear All Filters</span>
            <span x-show="selectedState !== 'all'" class="ml-2 bg-white/20 px-2 py-0.5 rounded-full text-xs" x-text="selectedState"></span>
          </button>
          
          <!-- Enhanced filters dropdown -->
          <div x-show="showFilters" 
               x-transition:enter="transition ease-out duration-200"
               x-transition:enter-start="opacity-0 transform scale-95"
               x-transition:enter-end="opacity-100 transform scale-100"
               x-transition:leave="transition ease-in duration-150"
               x-transition:leave-start="opacity-100 transform scale-100"
               x-transition:leave-end="opacity-0 transform scale-95"
               class="absolute top-full left-0 right-0 glass border border-gray-200 rounded-xl shadow-xl mt-2 z-50 p-4">
            <div class="space-y-4">
              <!-- Enhanced state filter label -->
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold text-gray-800">Filter by State</div>
                <div class="text-xs text-gray-500" x-text="`${filteredLocations.length} shown`"></div>
              </div>
              
              <!-- Enhanced state buttons grid -->
              <div class="grid grid-cols-3 gap-2">
                <template x-for="state in stateOptions" :key="state.value">
                  <button @click="selectState(state.value)" 
                          :class="selectedState === state.value ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-md' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'"
                          class="px-3 py-2 rounded-lg text-xs font-medium transition-all duration-200 text-center hover-lift" 
                          x-text="state.label">
                  </button>
                </template>
              </div>
              
              <!-- Clear filters button -->
              <button x-show="selectedState !== 'all' || searchQuery.trim() !== ''" 
                      @click="clearAllFilters()"
                      class="w-full mt-4 px-3 py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg text-xs font-medium transition-all duration-200 shadow-md hover:shadow-lg">
                <svg class="w-3 h-3 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                Clear all filters
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Stats Badge -->
    <div class="absolute bottom-6 z-30 transition-all duration-300" 
         :class="{ 'left-[25rem]': showList, 'left-6': !showList, 'mobile-bottom': true }">
      <div class="glass rounded-xl px-4 py-3 shadow-lg border border-gray-200 hover-lift">
        <div class="flex items-center space-x-3">
          <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
          <div class="text-sm font-medium text-gray-900">
            <span x-text="filteredLocations.length" class="font-bold text-blue-600"></span>
            <span class="text-gray-600">AIL facilities</span>
            <span x-show="selectedState !== 'all'" class="text-gray-500">in <span x-text="selectedState" class="font-medium"></span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Location Details Panel -->
    <div x-show="selectedLocation" 
         x-transition:enter="slide-in-right" 
         x-transition:leave="slide-out-right"
         class="absolute top-6 right-6 w-80 z-40 mobile-full">
      <div class="glass rounded-2xl p-6 shadow-2xl border border-gray-200">
        <template x-if="selectedLocation">
          <div>
            <!-- Enhanced header with close button -->
            <div class="flex justify-between items-start mb-6">
              <div class="flex-1 pr-3">
                <h3 class="font-bold text-gray-900 text-lg leading-tight mb-1" x-text="selectedLocation.name"></h3>
                <div class="flex items-center space-x-2">
                  <span class="state-badge text-xs px-2 py-1 rounded-full font-medium" x-text="selectedLocation.state"></span>
                  <span x-show="selectedLocation.distance" class="text-xs text-gray-500">
                    <span x-text="Math.round(selectedLocation.distance * 10) / 10"></span> km away
                  </span>
                </div>
              </div>
              <button @click="selectedLocation = null" 
                      class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-xl p-2 transition-all duration-200 focus-ring">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <!-- Enhanced details section -->
            <div class="space-y-4">
              <!-- Address section -->
              <div class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                  <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  </svg>
                </div>
                <div class="text-sm leading-relaxed min-w-0 flex-1">
                  <div x-show="selectedLocation.address && selectedLocation.address !== 'Mobile Inspector'" 
                       x-text="selectedLocation.address" 
                       class="font-medium text-gray-900 mb-1"></div>
                  <div x-show="selectedLocation.address === 'Mobile Inspector'" 
                       class="font-medium text-blue-600 mb-1">📱 Mobile Inspector Service</div>
                  <div class="text-gray-600">
                    <span x-show="selectedLocation.suburb" x-text="selectedLocation.suburb"></span>
                    <span x-show="selectedLocation.suburb && selectedLocation.state">, </span>
                    <span x-show="selectedLocation.state" x-text="selectedLocation.state"></span>
                    <span x-show="selectedLocation.postcode" class="ml-1" x-text="selectedLocation.postcode"></span>
                  </div>
                </div>
              </div>
              
              <!-- Inspector section -->
              <div x-show="hasNamedInspector(selectedLocation)" class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                  <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
                <div class="text-sm">
                  <div class="text-gray-500 text-xs uppercase tracking-wide mb-1">Inspector</div>
                  <div class="text-gray-900 font-medium" x-text="selectedLocation.inspector"></div>
                </div>
              </div>
              
              <!-- Enhanced action buttons -->
              <div class="flex space-x-3 pt-4">
                <button @click="getDirections(selectedLocation)"
                        class="flex-1 quick-action bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m0 0L9 7"></path>
                  </svg>
                  Directions
                </button>
                <a :href="'tel:' + selectedLocation.phone" 
                   class="flex-1 quick-action bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                  </svg>
                  Call
                </a>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

  </div>

  <!-- Enhanced Footer -->
  <footer class="bg-gradient-to-r from-gray-50 to-gray-100 border-t border-gray-200 text-sm text-center text-gray-600 p-6">
    <div class="flex items-center justify-center space-x-2">
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>&copy; 2025 Safe Freight Program. All rights reserved.</span>
    </div>
  </footer>

  <!-- Enhanced JavaScript with performance improvements -->
  <script>
    let map, markers = [], ailData = [], mapInitialized = false, ailFinderComponent = null;
    let markersVisible = true;
    let clusterManager = null; // For potential clustering

    const australiaBounds = { north: -5.0, south: -48.0, west: 108.0, east: 158.0 };
    const stateBounds = {
      NSW: { north: -28.15, south: -37.5, west: 140.9, east: 153.6 },
      QLD: { north: -10.0, south: -29.2, west: 137.9, east: 154.0 },
      VIC: { north: -33.9, south: -39.2, west: 140.9, east: 150.0 },
      SA: { north: -25.9, south: -38.1, west: 129.0, east: 141.0 },
      WA: { north: -13.7, south: -35.1, west: 112.9, east: 129.0 },
      NT: { north: -10.9, south: -26.0, west: 129.0, east: 138.0 },
      TAS: { north: -39.2, south: -43.6, west: 143.8, east: 148.4 }
    };

    function enhancedAilFinder() {
      return {
        filteredLocations: [],
        selectedLocation: null,
        loadingLocation: false,
        loading: true,
        userLocation: null,
        selectedState: 'all',
        searchQuery: '',
        showFilters: false,
        showList: false,
        showSearchResults: false,
        searchSuggestions: [],
        highlightedIndex: -1,
        
        stateOptions: [
          { value: 'all', label: 'All States' },
          { value: 'NSW', label: 'NSW' },
          { value: 'QLD', label: 'QLD' },
          { value: 'VIC', label: 'VIC' },
          { value: 'SA', label: 'SA' },
          { value: 'WA', label: 'WA' },
          { value: 'NT', label: 'NT' },
          { value: 'TAS', label: 'TAS' }
        ],

        async init() {
          ailFinderComponent = this;
          try {
            const paths = [
              './data/ail-locations.json',
              'data/ail-locations.json',
              '/data/ail-locations.json',
              './ail-locations.json'
            ];
            
            let response, jsonText;
            
            for (const path of paths) {
              try {
                response = await fetch(path);
                if (response.ok) {
                  jsonText = await response.text();
                  break;
                }
              } catch (e) {
                continue;
              }
            }
            
            if (!response?.ok || !jsonText) {
              throw new Error('Could not find ail-locations.json');
            }
            
            let rawData = JSON.parse(jsonText);
            console.log('✅ Loaded', rawData.length, 'raw locations');
            
            // Enhanced data processing with better validation
            ailData = rawData.map(location => {
              const lat = parseFloat(location.lat);
              const lng = parseFloat(location.lng);
              
              return {
                ...location,
                lat: lat,
                lng: lng,
                id: parseInt(location.id),
                address: location.address || null,
                suburb: location.suburb || null,
                inspector: location.inspector || '-',
                phone: location.phone || '',
                state: location.state || ''
              };
            }).filter(location => {
              const isValid = !isNaN(location.lat) && !isNaN(location.lng) && 
                             location.lat && location.lng &&
                             location.lat >= -48 && location.lat <= -5 &&
                             location.lng >= 108 && location.lng <= 158;
              
              if (!isValid) {
                console.warn(`❌ Invalid coordinates for: ${location.name}`);
              }
              
              return isValid;
            });
            
            console.log('✅ Processed', ailData.length, 'valid locations');
            
            this.filteredLocations = [...ailData];
            this.loading = false;
            
            // Initialize map when ready
            setTimeout(() => {
              if (window.google?.maps && !mapInitialized) {
                initMap();
              }
            }, 500);
            
            // Load markers after map initialization
            setTimeout(() => {
              if (window.google?.maps && mapInitialized && markers.length === 0) {
                loadMarkers();
              }
            }, 2000);
            
          } catch (error) {
            console.error('❌ Error loading AIL data:', error);
            this.loading = false;
            alert('Unable to load AIL location data. Please check your internet connection and try again.');
          }
        },

        // Enhanced filter methods with performance improvements
        clearAllFilters() {
          this.selectedState = 'all';
          this.searchQuery = '';
          this.showFilters = false;
          this.selectedLocation = null;
          this.showList = false;
          this.showSearchResults = false;
          this.searchSuggestions = [];
          this.filterLocations();
          
          if (mapInitialized) {
            setTimeout(() => this.fitMapToAustralia(), 100);
          }
        },

        selectState(state) {
          this.selectedState = state;
          this.filterLocations();
          
          if (mapInitialized) {
            setTimeout(() => {
              if (state !== 'all') {
                this.zoomToState(state);
              } else {
                this.fitMapToAustralia();
              }
            }, 100);
          }
        },

        handleSearch() {
          this.filterLocations();
          this.updateSearchSuggestions();
          this.highlightedIndex = -1;
        },

        // Enhanced keyboard navigation
        handleKeydown(event) {
          if (!this.showSearchResults || this.searchSuggestions.length === 0) return;
          
          const maxIndex = Math.min(this.searchSuggestions.length - 1, 7);
          
          switch(event.key) {
            case 'ArrowDown':
              event.preventDefault();
              this.highlightedIndex = this.highlightedIndex < maxIndex ? this.highlightedIndex + 1 : 0;
              this.scrollToHighlighted();
              break;
              
            case 'ArrowUp':
              event.preventDefault();
              this.highlightedIndex = this.highlightedIndex > 0 ? this.highlightedIndex - 1 : maxIndex;
              this.scrollToHighlighted();
              break;
              
            case 'Enter':
              event.preventDefault();
              if (this.highlightedIndex >= 0 && this.highlightedIndex <= maxIndex) {
                this.selectSuggestion(this.searchSuggestions[this.highlightedIndex]);
              }
              break;
              
            case 'Escape':
              this.showSearchResults = false;
              this.highlightedIndex = -1;
              break;
          }
        },

        scrollToHighlighted() {
          setTimeout(() => {
            const dropdown = document.querySelector('[x-show="showSearchResults && searchQuery.trim() !== \'\' && searchSuggestions.length > 0"]');
            const highlighted = dropdown?.children[this.highlightedIndex];
            if (highlighted) {
              highlighted.scrollIntoView({ 
                block: 'nearest', 
                behavior: 'smooth' 
              });
            }
          }, 10);
        },

        // Enhanced search suggestions with better performance
        updateSearchSuggestions() {
          if (this.searchQuery.trim() === '') {
            this.searchSuggestions = [];
            this.highlightedIndex = -1;
            return;
          }
          
          const query = this.searchQuery.toLowerCase().trim();
          
          let suggestions = ailData.filter(location => 
            location.name.toLowerCase().includes(query) ||
            (location.suburb && location.suburb.toLowerCase().includes(query)) ||
            location.state.toLowerCase().includes(query) ||
            (location.address && location.address.toLowerCase().includes(query))
          );
          
          if (this.selectedState !== 'all') {
            suggestions = suggestions.filter(location => location.state === this.selectedState);
          }
          
          this.searchSuggestions = suggestions.slice(0, 10);
          this.highlightedIndex = -1;
        },

        selectSuggestion(suggestion) {
          this.searchQuery = suggestion.name;
          this.showSearchResults = false;
          this.highlightedIndex = -1;
          this.selectedLocation = suggestion;
          this.filterLocations();
          
          if (mapInitialized) {
            setTimeout(() => {
              map.setCenter({ lat: suggestion.lat, lng: suggestion.lng });
              map.setZoom(12);
              
              // Add a bounce animation to the marker
              const marker = markers.find(m => {
                const pos = m.getPosition();
                return Math.abs(pos.lat() - suggestion.lat) < 0.0001 && 
                       Math.abs(pos.lng() - suggestion.lng) < 0.0001;
              });
              
              if (marker) {
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => marker.setAnimation(null), 2000);
              }
            }, 100);
          }
        },

        // Enhanced filtering with performance optimizations
        filterLocations() {
          let filtered = [...ailData];
          
          if (this.selectedState !== 'all') {
            filtered = filtered.filter(location => location.state === this.selectedState);
          }
          
          if (this.searchQuery.trim()) {
            const query = this.searchQuery.toLowerCase().trim();
            filtered = filtered.filter(location => 
              location.name.toLowerCase().includes(query) ||
              (location.suburb && location.suburb.toLowerCase().includes(query)) ||
              location.state.toLowerCase().includes(query) ||
              (location.address && location.address.toLowerCase().includes(query))
            );
          }
          
          this.filteredLocations = filtered;
          
          if (mapInitialized) {
            this.updateMapMarkers();
          }
        },

        // Optimized marker visibility updates
        updateMapMarkers() {
          const filteredIds = new Set(this.filteredLocations.map(loc => `${loc.lat}-${loc.lng}`));
          
          markers.forEach(marker => {
            const pos = marker.getPosition();
            const markerId = `${pos.lat()}-${pos.lng()}`;
            marker.setVisible(filteredIds.has(markerId));
          });
        },

        // Enhanced geolocation with better error handling
        async findNearest() {
          if (!navigator.geolocation) {
            alert('Geolocation is not supported by this browser.');
            return;
          }
          
          this.loadingLocation = true;
          
          try {
            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutes
              });
            });
            
            this.userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            
            const locationsWithDistance = ailData.map(location => ({
              ...location,
              distance: this.calculateDistance(
                this.userLocation.lat,
                this.userLocation.lng,
                location.lat,
                location.lng
              )
            })).sort((a, b) => a.distance - b.distance);
            
            this.filteredLocations = locationsWithDistance;
            this.selectedState = 'all';
            this.searchQuery = '';
            
            if (mapInitialized) {
              map.setCenter(this.userLocation);
              map.setZoom(10);
              
              // Add user location marker
              new google.maps.Marker({
                position: this.userLocation,
                map: map,
                title: 'Your Location',
                icon: {
                  url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="8" fill="#3b82f6" stroke="white" stroke-width="3"/>
                      <circle cx="12" cy="12" r="3" fill="white"/>
                    </svg>
                  `),
                  scaledSize: new google.maps.Size(24, 24),
                  anchor: new google.maps.Point(12, 12)
                }
              });
            }
            
          } catch (error) {
            console.error('Error getting location:', error);
            let message = 'Unable to get your location. ';
            
            switch(error.code) {
              case 1:
                message += 'Please check your browser permissions and try again.';
                break;
              case 2:
                message += 'Location information is unavailable.';
                break;
              case 3:
                message += 'Location request timed out.';
                break;
              default:
                message += 'Please try again.';
            }
            
            alert(message);
          } finally {
            this.loadingLocation = false;
          }
        },

        returnToAustraliaView() {
          this.userLocation = null;
          this.filteredLocations = [...ailData];
          this.selectedState = 'all';
          this.searchQuery = '';
          
          if (mapInitialized) {
            setTimeout(() => this.fitMapToAustralia(), 100);
          }
        },

        // Utility methods
        calculateDistance(lat1, lng1, lat2, lng2) {
          const R = 6371; // Earth's radius in km
          const dLat = this.toRadians(lat2 - lat1);
          const dLng = this.toRadians(lng2 - lng1);
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                   Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
                   Math.sin(dLng/2) * Math.sin(dLng/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          return R * c;
        },

        toRadians(degrees) {
          return degrees * (Math.PI/180);
        },

        getDisplayAddress(location) {
          if (location.address === 'Mobile Inspector') {
            return `📱 Mobile Inspector - ${location.state}`;
          }
          
          const parts = [];
          if (location.address) parts.push(location.address);
          if (location.suburb) parts.push(location.suburb);
          if (location.state && location.postcode) parts.push(`${location.state} ${location.postcode}`);
          
          return parts.join(', ');
        },

        // Enhanced directions with app detection
        getDirections(location) {
          const address = this.getDisplayAddress(location);
          const encodedAddress = encodeURIComponent(address);
          
          const googleMapsApp = `comgooglemaps://?daddr=${encodedAddress}`;
          const googleMapsWeb = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
          
          // Enhanced mobile detection
          const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          
          if (isMobile) {
            // Try to open in app first, then fallback to web
            window.location.href = googleMapsApp;
            setTimeout(() => {
              window.open(googleMapsWeb, '_blank');
            }, 1000);
          } else {
            window.open(googleMapsWeb, '_blank');
          }
        },

        hasNamedInspector(location) {
          return location.inspector && location.inspector !== '-';
        },

        viewOnMap(location) {
          this.selectedLocation = location;
          this.showList = false;
          
          if (mapInitialized) {
            this.zoomToLocation(location);
          }
        },

        // Enhanced map interaction methods
        zoomToLocation(location) {
          if (!mapInitialized) return;
          
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            map.setCenter({ lat: location.lat, lng: location.lng });
            map.setZoom(12);
            
            // Find and animate the marker
            const marker = markers.find(m => {
              const pos = m.getPosition();
              return Math.abs(pos.lat() - location.lat) < 0.0001 && 
                     Math.abs(pos.lng() - location.lng) < 0.0001;
            });
            
            if (marker) {
              marker.setAnimation(google.maps.Animation.BOUNCE);
              setTimeout(() => marker.setAnimation(null), 1500);
            }
          }, 100);
        },

        zoomToState(state) {
          if (!mapInitialized || !stateBounds[state]) return;
          
          const bounds = stateBounds[state];
          
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            const mapBounds = new google.maps.LatLngBounds(
              new google.maps.LatLng(bounds.south, bounds.west),
              new google.maps.LatLng(bounds.north, bounds.east)
            );
            map.fitBounds(mapBounds);
            
            setTimeout(() => {
              const currentZoom = map.getZoom();
              let zoomReduction = ['TAS', 'NT'].includes(state) ? 0.3 : 
                                (['SA', 'VIC'].includes(state) ? 0.4 : 0.5);
              if (currentZoom > 5) {
                map.setZoom(Math.max(currentZoom - zoomReduction, 5));
              }
            }, 200);
          }, 50);
        },

        fitMapToAustralia() {
          if (!mapInitialized) return;
          
          setTimeout(() => {
            google.maps.event.trigger(map, 'resize');
            const bounds = new google.maps.LatLngBounds(
              new google.maps.LatLng(australiaBounds.south, australiaBounds.west),
              new google.maps.LatLng(australiaBounds.north, australiaBounds.east)
            );
            map.fitBounds(bounds);
            setTimeout(() => {
              map.setZoom(Math.max(map.getZoom() - 0.5, 4.0));
            }, 300);
          }, 100);
        }
      }
    }

    // Enhanced map initialization
    function initMap() {
      try {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 5,
          center: { lat: -25.0, lng: 134.0 },
          mapTypeId: 'roadmap',
          zoomControl: true,
          zoomControlOptions: { 
            position: google.maps.ControlPosition.RIGHT_BOTTOM 
          },
          streetViewControl: false,
          mapTypeControl: false,
          fullscreenControl: true,
          disableDefaultUI: false,
          gestureHandling: 'cooperative',
          restriction: {
            latLngBounds: {
              north: -8.0,
              south: -45.0,
              west: 110.0,
              east: 155.0
            },
            strictBounds: false
          },
          // Enhanced map styling
          styles: [
            {
              featureType: "poi",
              elementType: "labels",
              stylers: [{ visibility: "off" }]
            },
            {
              featureType: "transit",
              elementType: "labels",
              stylers: [{ visibility: "off" }]
            },
            {
              featureType: "road",
              elementType: "labels.icon",
              stylers: [{ visibility: "off" }]
            },
            {
              featureType: "water",
              elementType: "geometry.fill",
              stylers: [{ color: "#a2daf2" }]
            },
            {
              featureType: "landscape",
              elementType: "geometry.fill",
              stylers: [{ color: "#f5f5f2" }]
            }
          ]
        });
        
        // Force zoom controls to appear after map loads
        google.maps.event.addListenerOnce(map, 'idle', () => {
          // Ensure zoom controls are visible
          map.setOptions({
            zoomControl: true,
            zoomControlOptions: {
              position: google.maps.ControlPosition.RIGHT_BOTTOM,
              style: google.maps.ZoomControlStyle.DEFAULT
            }
          });
        });
        
        mapInitialized = true;
        console.log('✅ Map initialized successfully');
        
        if (ailData.length > 0) {
          loadMarkers();
        }
        
        // Set initial Australia view
        setTimeout(() => {
          const bounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(australiaBounds.south, australiaBounds.west),
            new google.maps.LatLng(australiaBounds.north, australiaBounds.east)
          );
          map.fitBounds(bounds);
          setTimeout(() => {
            map.setZoom(Math.max(map.getZoom() - 0.5, 4.0));
          }, 300);
        }, 100);
        
        // Close location details when clicking map
        map.addListener('click', () => {
          if (ailFinderComponent?.selectedLocation) {
            ailFinderComponent.selectedLocation = null;
          }
        });
        
      } catch (error) {
        console.error('❌ Error initializing map:', error);
      }
    }

    // Enhanced marker loading with better performance
    function loadMarkers() {
      if (!mapInitialized || !ailData.length) return;
      
      console.log(`🗺️ Loading ${ailData.length} markers...`);
      
      // Clear existing markers
      markers.forEach(marker => marker.setMap(null));
      markers = [];
      
      // Create enhanced marker icon
      const createMarkerIcon = (isSelected = false) => {
        const color = isSelected ? '#ef4444' : '#1e40af';
        const size = isSelected ? 36 : 32;
        const height = isSelected ? 45 : 40;
        
        return {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg width="${size}" height="${height}" viewBox="0 0 ${size} ${height}" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                  <dropShadow dx="0" dy="3" stdDeviation="3" flood-color="#000000" flood-opacity="0.3"/>
                </filter>
              </defs>
              <path d="M${size/2} 0C${size/2 * 0.45} 0 0 ${size/2 * 0.45} 0 ${size/2}c0 ${size/2 * 0.55} ${size/2} ${height - size/2} ${size/2} ${height - size/2}s${size/2}-${(height - size/2) * 0.633} ${size/2}-${height - size/2}C${size} ${size/2 * 0.45} ${size/2 * 1.55} 0 ${size/2} 0z" 
                    fill="${color}" 
                    stroke="white" 
                    stroke-width="2" 
                    filter="url(#shadow)"/>
              <circle cx="${size/2}" cy="${size/2}" r="${size/4}" fill="white"/>
              <circle cx="${size/2}" cy="${size/2}" r="${size/8}" fill="${color}"/>
            </svg>
          `),
          scaledSize: new google.maps.Size(size, height),
          anchor: new google.maps.Point(size/2, height)
        };
      };
      
      // Create markers with enhanced interaction
      ailData.forEach((ail, index) => {
        try {
          const marker = new google.maps.Marker({
            position: { lat: ail.lat, lng: ail.lng },
            map: map,
            title: ail.name,
            icon: createMarkerIcon(false),
            animation: google.maps.Animation.DROP,
            optimized: true // Performance optimization
          });
          
          // Enhanced click handler
          marker.addListener("click", () => {
            if (ailFinderComponent) {
              ailFinderComponent.selectedLocation = ail;
              map.panTo(marker.getPosition());
              
              // Update marker appearance
              marker.setIcon(createMarkerIcon(true));
              
              // Reset other markers
              markers.forEach(m => {
                if (m !== marker) {
                  m.setIcon(createMarkerIcon(false));
                }
              });
            }
          });
          
          // Hover effects
          marker.addListener("mouseover", () => {
            if (ailFinderComponent?.selectedLocation?.id !== ail.id) {
              marker.setIcon(createMarkerIcon(false));
            }
          });
          
          markers.push(marker);
          
        } catch (error) {
          console.error(`❌ Error creating marker for ${ail.name}:`, error);
        }
      });
      
      console.log(`✅ Successfully loaded ${markers.length} markers on map`);
    }

    // Global map initialization
    window.initMap = initMap;

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      if (window.google?.maps && !mapInitialized) {
        setTimeout(initMap, 1000);
      }
    });

    // Enhanced component loader with error handling
    async function loadComponent(elementId, componentPath) {
      try {
        const response = await fetch(componentPath);
        if (response.ok) {
          const content = await response.text();
          const element = document.getElementById(elementId);
          if (element) {
            element.innerHTML = content;
          }
        } else {
          console.error(`Failed to load component: ${componentPath}`);
        }
      } catch (error) {
        console.error(`Error loading component ${componentPath}:`, error);
      }
    }

    // Load header and footer components
    document.addEventListener('DOMContentLoaded', () => {
      loadComponent('header-component', '/components/header.html');
      loadComponent('footer-component', '/components/footer.html');
    });

    // Performance monitoring
    if (typeof performance !== 'undefined') {
      window.addEventListener('load', () => {
        setTimeout(() => {
          const perfData = performance.getEntriesByType('navigation')[0];
          console.log(`📊 Page load time: ${Math.round(perfData.loadEventEnd - perfData.fetchStart)}ms`);
        }, 0);
      });
    }
  </script>

  <!-- Google Maps API with callback -->
  <script async defer 
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPnUqhxYzzgoRJ32Rh6-bg5wmKuXtBmKI&callback=initMap&libraries=geometry">
  </script>
</body>
</html>
