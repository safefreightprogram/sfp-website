<!DOCTYPE html>

<html lang="en-AU">
<head>
    <meta name="robots" content="noindex,nofollow">

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<meta content="yes" name="mobile-web-app-capable"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<title>Vehicle Inspection ‚Äì Safe Freight Program</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<style>
    /* Mobile responsive improvements */
    @media (max-width: 768px) {
      .form-section {
        margin-bottom: 1rem;
      }
      
      /* Compact radio buttons on mobile */
      .mobile-radio-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-start;
      }
      
      .mobile-radio-option {
        padding: 0.5rem 0.75rem;
        min-height: 40px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        white-space: nowrap;
        flex: 0 0 auto;
      }
      
      .mobile-radio-option:has(input:checked) {
        background: #dbeafe;
        border-color: #3b82f6;
      }
      
      /* Reset mobile styles on larger screens */
      .sm\:mobile-radio-option-reset {
        padding: 0;
        background: none;
        border: none;
        border-radius: 0;
        min-height: auto;
      }
      
      /* Better mobile keyboard handling */
      .mobile-keyboard-active {
        position: relative;
        z-index: 1000;
      }
      
      /* Ensure content is visible above mobile keyboards */
      body {
        padding-bottom: env(safe-area-inset-bottom, 20px);
      }
    }
    
    /* Better mobile touch targets */
    @media (max-width: 640px) {
      input, select, textarea, button {
        min-height: 44px;
      }
      
      .radio-option {
        padding: 0.5rem;
        min-height: 40px;
      }
      
      /* More compact spacing on mobile */
      .mobile-form-spacing {
        gap: 1rem;
      }
      
      .mobile-section-spacing {
        margin-bottom: 1rem;
      }
    }

    /* File upload styling */
    .file-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .file-upload-area:hover,
    .file-upload-area.dragover {
      border-color: #3b82f6;
      background-color: #f0f9ff;
    }

    .file-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem;
      margin: 0.25rem 0;
      background-color: #f9fafb;
      border-radius: 0.375rem;
      border: 1px solid #e5e7eb;
    }

    .file-item button {
      color: #ef4444;
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
    }

    .file-item button:hover {
      background-color: #fee2e2;
      border-radius: 0.25rem;
    }
  </style>
<!-- Firebase Auth Setup -->
<script src="/js/unified-auth.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBURlJUicOTobRLghN2RyEZfXEZvU_uiYU",
      authDomain: "safe-freight-program.firebaseapp.com",
      projectId: "safe-freight-program",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // AIL mapping - email to AIL name and inspector name
    const ailMapping = {
      "safefreightprogram@gmail.com": { ail: "SFP Head Office", name: "Darren Jenkins" },
      "safrightprogram@gmail.com": { ail: "SFP Alternative Office", name: "Alternative Inspector" }
      // Add more email to AIL and name mappings as needed
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) return window.location.href = "/login.html";

      const userMapping = ailMapping[user.email.toLowerCase()];
      if (!userMapping) return window.location.href = "/lookup-vehicle.html";

      document.getElementById("userPanel").classList.remove("hidden");
      document.getElementById("formWrapper").classList.remove("hidden");
      document.getElementById("inspectorEmailField").value = user.email;
      document.getElementById("ailNameField").value = userMapping.ail;
      document.getElementById("inspectorName").textContent = userMapping.name;
      document.getElementById("userInfo").textContent = user.email;

      // Load inspection schema - fallback to local schema if fetch fails
      fetch('/data/forms/SFP-Tanker-Trailer-Inspection-Schema.json')
        .then(res => res.json())
        .then(schema => renderInspectionForm(schema))
        .catch(err => {
          console.warn("Failed to load inspection schema from server, using fallback", err);
          // Fallback schema
          const fallbackSchema = {
            sections: [
              {
                title: "Identification & Placarding",
                items: [
                  "Emergency info panels are clean, visible, and legible on both sides and rear",
                  "UN number displayed correctly on panels and placards",
                  "Placards are appropriate for the load and securely mounted",
                  "Vehicle identification numbers are visible and match documentation"
                ]
              },
              {
                title: "Structural Integrity",
                items: [
                  "Tank shell shows no signs of corrosion, dents, or damage",
                  "Welds and joints are intact with no visible cracks",
                  "Support framework and mounting points are secure",
                  "Walkways and platforms are structurally sound"
                ]
              },
              {
                title: "Safety Equipment",
                items: [
                  "Fire extinguisher is present, charged, and within service date",
                  "Emergency response equipment is accessible and complete",
                  "Spill response kit is present and adequate",
                  "Personal protective equipment meets requirements"
                ]
              }
            ]
          };
          renderInspectionForm(fallbackSchema);
        });
    });

    window.signOutUser = () => {
      signOut(auth).then(() => window.location.href = "/login.html");
    };
  </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans" data-requires-auth="true" data-requires-role="inspector">
<!-- Header with Navigation -->
<header class="bg-blue-900 text-white sticky top-0 z-50 shadow" x-data="{ open: false, showSearch: false }">
<div class="max-w-7xl mx-auto p-4 flex justify-between items-center relative">
<div class="flex items-center space-x-3">
<a class="transition-transform transform hover:scale-[1.05]" href="index.html">
<img alt="Safe Freight Program" class="h-8 w-auto" src="SFP-Logo.png"/>
</a>
</div>
<!-- Controls -->
<div class="flex items-center space-x-4">
<button @click="showSearch = !showSearch" class="inline-flex transition-transform transform hover:scale-105">
<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M21 21l-4.35-4.35m1.35-4.65a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<button @click="open = !open" class="inline-flex transition-transform transform hover:scale-105">
<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<!-- Search bar -->
<div @click.away="showSearch = false" class="absolute top-full right-0 bg-blue-900 shadow-md z-40 w-full sm:w-80 md:w-72 lg:w-64" x-show="showSearch" x-transition="">
<div class="p-4">
<form action="search.html" method="GET">
<input class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-500 text-black" name="q" placeholder="Search..." type="search"/>
</form>
</div>
</div>
<!-- Navigation menu -->
<div :class="showSearch ? 'mt-16 sm:mt-0 sm:right-80 md:right-72 lg:right-64' : ''" @click.away="open = false" class="absolute top-full right-0 bg-blue-900 text-white text-sm z-50 shadow-md" x-show="open" x-transition="">
<nav class="flex flex-col">
<a class="block px-4 py-2 hover:bg-blue-800" href="about.html">About</a>
<a class="block px-4 py-2 hover:bg-blue-800" href="lookup-driver.html">Driver Lookup</a>
<a class="block px-4 py-2 hover:bg-blue-800" href="lookup-vehicle.html">Vehicle Lookup</a>
<a class="block px-4 py-2 hover:bg-blue-800" href="find-ail.html">Find AIL</a>
<a class="block px-4 py-2 hover:bg-blue-800" href="training.html">SFP Training</a>
<a class="block px-4 py-2 hover:bg-blue-800" href="ail-login.html">AIL Portal</a>
<a class="block px-4 py-2 hover:bg-blue-800" href="trainer-login.html">Trainer Login</a>
<a class="block px-4 py-2 hover:bg-blue-800" href="contact.html">Contact</a>
<a class="block px-4 py-2 hover:bg-blue-800" href="subscription.html">Subscribe</a>
</nav>
</div>
</div>
</header>
<div class="max-w-4xl mx-auto mt-12 p-6 bg-white shadow-lg rounded-lg">
<div class="text-right text-sm text-blue-700 mb-4 hidden" id="userPanel">
      Logged in as: <span id="userInfo"></span>
<button class="ml-2 text-red-600 underline" onclick="signOutUser()">Sign out</button>
</div>
<div class="hidden" id="formWrapper">
<h1 class="text-2xl font-bold mb-4 text-blue-800">Vehicle Inspection Submission</h1>
<p class="mb-6 text-sm text-gray-600">Authorised Inspectors only. Complete the inspection form and submit.</p>
<form class="space-y-6" id="inspectionForm">
<!-- Vehicle Identification Section -->
<div class="bg-gray-50 p-4 rounded-lg">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Vehicle Information</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">SFPV ID</label>
<div class="flex items-center border border-gray-300 rounded-md px-3 py-2 focus-within:ring-2 focus-within:ring-blue-500 bg-white">
<span class="text-blue-700 font-semibold pr-1">SFPV-</span>
<input autocomplete="off" class="flex-1 border-none focus:ring-0 focus:outline-none text-sm" id="sfpvNumberInput" inputmode="numeric" maxlength="6" name="sfpvNumber" pattern="[0-9]*" placeholder="001234" required="" type="text">
<button class="ml-2 p-1 text-blue-600 hover:text-blue-800 transition-colors flex items-center" onclick="startQRScan()" type="button">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M3 7h2l2-3h10l2 3h2a1 1 0 011 1v11a1 1 0 01-1 1H3a1 1 0 01-1-1V8a1 1 0 011-1zm9 3a4 4 0 100 8 4 4 0 000-8z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</input></div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Vehicle Registration</label>
<input class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" name="rego" placeholder="ABC123" required="" type="text"/>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">VIN</label>
<div class="flex items-center border border-gray-300 rounded-md px-3 py-2 focus-within:ring-2 focus-within:ring-blue-500">
<span class="text-gray-600 font-semibold pr-1">VIN</span>
<input class="flex-1 border-none focus:ring-0 focus:outline-none text-sm" name="vinNumber" placeholder="123456789" required="" type="text"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Vehicle Type</label>
<select class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" name="vehicleType" required="">
<option value="">-- Select Vehicle Type --</option>
<option value="Rigid Truck">Rigid Truck</option>
<option value="Prime Mover">Prime Mover</option>
<optgroup label="Trailers">
<option value="Box Trailer">¬†¬†¬†¬†Box Trailer</option>
<option value="Dog Trailer">¬†¬†¬†¬†Dog Trailer</option>
<option value="Dolly">¬†¬†¬†¬†Dolly</option>
<option value="Flat Bed">¬†¬†¬†¬†Flat Bed</option>
<option value="Pig Trailer">¬†¬†¬†¬†Pig Trailer</option>
<option value="Tanker">¬†¬†¬†¬†Tanker</option>
<option value="Vehicle Carrier">¬†¬†¬†¬†Vehicle Carrier</option>
</optgroup>
<option value="Buses">Buses</option>
<option value="Livestock Vehicle">Livestock Vehicle</option>
<option value="Special Purpose Vehicles">Special Purpose Vehicles</option>
</select>
</div>
</div>
</div>
<!-- Inspection Details Section -->
<div class="bg-gray-50 p-4 rounded-lg">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Inspection Details</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Inspector Email</label>
<input class="w-full border border-gray-300 px-3 py-2 rounded-md bg-gray-100 text-gray-600" id="inspectorEmailField" name="inspectorEmail" readonly="" type="email"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Inspection Date</label>
<input class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" name="inspectionDate" required="" type="date"/>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Inspection Outcome</label>
<select class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" name="outcome" required="">
<option value="">-- Inspection Outcome --</option>
<option value="Pass">Pass</option>
<option value="Fail">Fail</option>
<option value="Needs Repair">Needs Repair</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">AIL Name</label>
<input class="w-full border border-gray-300 px-3 py-2 rounded-md bg-gray-100 text-gray-600" id="ailNameField" name="ailName" readonly="" type="text"/>
</div>
</div>
<div class="mt-4">
<label class="block text-sm font-medium text-gray-700 mb-2">Comments</label>
<textarea class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mobile-textarea" name="comments" onblur="handleMobileKeyboardHide(this)" onfocus="handleMobileKeyboard(this)" placeholder="Optional inspection comments" rows="3"></textarea>
</div>
</div>
<!-- Document Upload Section -->
<div class="bg-gray-50 p-4 rounded-lg">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Supporting Documents</h3>
<p class="text-sm text-gray-600 mb-4">Upload relevant inspection documents, photos, or certificates (PDF, JPG, PNG - max 10MB each)</p>
<div class="file-upload-area" onclick="document.getElementById('fileInput').click()" ondragleave="handleDragLeave(event)" ondragover="handleDragOver(event)" ondrop="handleFileDrop(event)">
<div class="text-center">
<svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewbox="0 0 48 48">
<path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<p class="text-gray-600">Click to upload files or drag and drop</p>
<p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG up to 10MB each</p>
</div>
</div>
<input accept=".pdf,.jpg,.jpeg,.png" id="fileInput" multiple="" onchange="handleFileSelect(event)" style="display: none;" type="file"/>
<div class="file-list mt-4 hidden" id="fileList">
<h4 class="text-sm font-medium text-gray-700 mb-2">Selected Files:</h4>
<div id="fileItems"></div>
</div>
</div>
<!-- Dynamic Inspection Questions -->
<div class="space-y-6" id="formContainer"></div>
<!-- Digital Signature Section -->
<div class="bg-yellow-50 border border-yellow-200 p-6 rounded-lg">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Inspector Certification</h3>
<div class="mb-4">
<p class="text-sm text-gray-700 mb-4">
<strong>Legal Certification:</strong> I, <span class="font-semibold text-blue-700" id="inspectorName"></span>, hereby certify that I am an authorised nominee of the above-named Approved Inspection Location (AIL) and that the inspection detailed herein has been conducted in accordance with Safe Freight Program standards and regulations. This certification constitutes a legal declaration under applicable transport safety legislation.
            </p>
</div>
<!-- Signature Options -->
<div class="space-y-4">
<div>
<label class="flex items-center cursor-pointer">
<input class="mr-3" id="digitalSignature" name="signatureType" required="" type="radio" value="digital"/>
<span class="text-sm font-medium">Digital Signature (Touch/Mouse)</span>
</label>
</div>
<div class="hidden" id="signaturePadContainer">
<div class="border border-gray-300 rounded-md bg-white">
<canvas class="w-full h-32 rounded-md cursor-crosshair" id="signaturePad"></canvas>
</div>
<div class="flex justify-between mt-2">
<button class="text-sm text-blue-600 hover:text-blue-800" id="clearSignature" type="button">Clear Signature</button>
<span class="text-xs text-gray-500">Sign above with mouse or touch</span>
</div>
</div>
<div>
<label class="flex items-center cursor-pointer">
<input class="mr-3" id="checkboxSignature" name="signatureType" required="" type="radio" value="checkbox"/>
<span class="text-sm font-medium">I certify by checkbox (no touch screen available)</span>
</label>
</div>
</div>
</div>
<button class="w-full bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-md font-semibold transition-colors text-lg py-3" id="submitBtn" type="submit">
          Submit Inspection
        </button>
</form>
<div class="text-sm mt-4 text-center" id="formStatus"></div>
</div>
</div>
<!-- QR Scanner Modal -->
<div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden overflow-hidden" id="qrModal">
<div class="bg-white p-6 rounded-md shadow-md max-w-sm w-full relative">
<h3 class="text-lg font-semibold mb-4">Scan Vehicle QR Code</h3>
<div id="qr-reader" style="width: 100%;"></div>
<button class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl font-bold" onclick="stopQRScan()">√ó</button>
<div class="mt-4 text-center">
<button class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600" onclick="stopQRScan()">Cancel</button>
</div>
</div>
</div>
<script>
    let signaturePad;
    let qrScanner;
    let uploadedFiles = [];
    const maxFileSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];

    // File handling functions
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      processFiles(files);
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('dragover');
    }

    function handleFileDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('dragover');
      const files = Array.from(event.dataTransfer.files);
      processFiles(files);
    }

    function processFiles(files) {
      files.forEach(file => {
        // Validate file type
        if (!allowedTypes.includes(file.type)) {
          alert(`File "${file.name}" is not a supported format. Please use PDF, JPG, or PNG files.`);
          return;
        }

        // Validate file size
        if (file.size > maxFileSize) {
          alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
          return;
        }

        // Check for duplicates
        if (uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
          alert(`File "${file.name}" is already selected.`);
          return;
        }

        uploadedFiles.push(file);
      });

      updateFileList();
      // Clear the input so the same file can be selected again if removed and re-added
      document.getElementById('fileInput').value = '';
    }

    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      updateFileList();
    }

    function updateFileList() {
      const fileList = document.getElementById('fileList');
      const fileItems = document.getElementById('fileItems');
      
      if (uploadedFiles.length === 0) {
        fileList.classList.add('hidden');
        return;
      }

      fileList.classList.remove('hidden');
      fileItems.innerHTML = '';

      uploadedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <div class="flex items-center space-x-2">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span class="text-sm text-gray-700 truncate">${file.name}</span>
            <span class="text-xs text-gray-500">(${(file.size / 1024 / 1024).toFixed(1)}MB)</span>
          </div>
          <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        `;
        fileItems.appendChild(fileItem);
      });
    }

    // Convert file to base64 for storage
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Mobile keyboard handling - improved
    let activeInput = null;
    let keyboardHeight = 0;

    function handleMobileKeyboard(element) {
      if (window.innerWidth <= 768) {
        activeInput = element;
        element.classList.add('mobile-keyboard-active');
        
        // Add small delay to ensure keyboard is visible
        setTimeout(() => {
          // Get the keyboard height estimation
          const viewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
          keyboardHeight = window.innerHeight - viewportHeight;
          
          // Calculate position to keep textarea just above keyboard
          const elementRect = element.getBoundingClientRect();
          const targetPosition = viewportHeight - 150; // Leave 150px above keyboard
          
          if (elementRect.bottom > targetPosition) {
            const scrollAmount = elementRect.bottom - targetPosition;
            window.scrollBy({
              top: scrollAmount,
              behavior: 'smooth'
            });
          }
        }, 300);
      }
    }

    function handleMobileKeyboardHide(element) {
      if (activeInput === element) {
        activeInput = null;
        element.classList.remove('mobile-keyboard-active');
      }
    }

    // Handle visual viewport changes (better keyboard detection)
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        if (activeInput && window.innerWidth <= 768) {
          const viewportHeight = window.visualViewport.height;
          const keyboardVisible = viewportHeight < window.innerHeight * 0.8;
          
          if (keyboardVisible) {
            // Keyboard is visible, adjust active input position
            setTimeout(() => {
              const elementRect = activeInput.getBoundingClientRect();
              const targetPosition = viewportHeight - 120; // Keep 120px above keyboard
              
              if (elementRect.bottom > targetPosition) {
                const scrollAmount = elementRect.bottom - targetPosition;
                window.scrollBy({
                  top: scrollAmount,
                  behavior: 'smooth'
                });
              }
            }, 100);
          }
        }
      });
    }

    // Fallback for older browsers
    let initialViewportHeight = window.innerHeight;
    
    window.addEventListener('resize', () => {
      if (!window.visualViewport && window.innerWidth <= 768) {
        const currentHeight = window.innerHeight;
        const keyboardVisible = currentHeight < initialViewportHeight * 0.75;
        
        if (keyboardVisible && activeInput) {
          setTimeout(() => {
            const elementRect = activeInput.getBoundingClientRect();
            const targetPosition = currentHeight - 120;
            
            if (elementRect.bottom > targetPosition) {
              const scrollAmount = elementRect.bottom - targetPosition;
              window.scrollBy({
                top: scrollAmount,
                behavior: 'smooth'
              });
            }
          }, 100);
        }
      }
    });

    // Pad SFPV number with zeros (ensure exactly 6 digits)
    function padSFPVNumber(input) {
      return input.padStart(6, '0').slice(-6); // Take only last 6 digits if longer
    }

    // Enforce 6 digit limit on SFPV input
    document.addEventListener('DOMContentLoaded', function() {
      const sfpvInput = document.getElementById('sfpvNumberInput');
      if (sfpvInput) {
        sfpvInput.addEventListener('input', function(e) {
          // Remove any non-digit characters and limit to 6 digits
          let value = e.target.value.replace(/\D/g, '').slice(0, 6);
          e.target.value = value;
        });
      }
    });

    // QR Code scanning functions
    function startQRScan() {
      const modal = document.getElementById('qrModal');
      modal.classList.remove('hidden');
      qrScanner = new Html5Qrcode("qr-reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          qrScanner.stop();
          modal.classList.add('hidden');
          
          // Extract SFPV ID from the scanned URL
          let sfpvId = decodedText.trim();
          console.log('Scanned QR code:', sfpvId);

          // Handle the lookup-vehicle?id= format
          if (sfpvId.includes('?id=')) {
            sfpvId = sfpvId.split('?id=')[1];
          }
          // Handle other possible formats
          else if (sfpvId.includes('/vehicle/')) {
            sfpvId = sfpvId.split('/vehicle/')[1];
          }

          // Remove any URL parameters after the ID
          if (sfpvId.includes('&')) {
            sfpvId = sfpvId.split('&')[0];
          }

          // Remove SFPV- prefix if present to get just the number
          if (sfpvId.startsWith('SFPV-')) {
            sfpvId = sfpvId.substring(5);
          }

          console.log('Extracted SFPV number:', sfpvId);
          document.getElementById('sfpvNumberInput').value = sfpvId;
        },
        (err) => {} // Handle errors silently
      );
    }

    function stopQRScan() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          document.getElementById('qrModal').classList.add('hidden');
        }).catch(err => {
          console.error("Error stopping QR scanner:", err);
          document.getElementById('qrModal').classList.add('hidden');
        });
      }
    }

    function renderInspectionForm(schema) {
      const container = document.getElementById("formContainer");
      container.innerHTML = "";

      schema.sections.forEach((section, sIdx) => {
        const sectionEl = document.createElement("div");
        sectionEl.className = "bg-gray-50 p-6 rounded-lg shadow-sm";
        sectionEl.innerHTML = `
          <h2 class="text-xl font-bold text-blue-800 mb-4">${section.title}</h2>
          <div class="space-y-4">
          ${section.items.map((item, i) => `
            <div class="bg-white p-3 sm:p-4 rounded-md border border-gray-200 mobile-section-spacing">
              <label class="block font-medium text-gray-700 mb-3 text-sm sm:text-base">${item}</label>
              <div class="mobile-radio-group sm:flex sm:flex-wrap sm:items-center sm:gap-4 sm:gap-6 text-sm mb-3">
                <label class="flex items-center cursor-pointer mobile-radio-option sm:mobile-radio-option-reset">
                  <input type="radio" name="q-${sIdx}-${i}" value="Pass" required class="mr-2 text-green-600"> 
                  <span class="text-green-600 font-medium">‚úì Pass</span>
                </label>
                <label class="flex items-center cursor-pointer mobile-radio-option sm:mobile-radio-option-reset">
                  <input type="radio" name="q-${sIdx}-${i}" value="Fail" class="mr-2 text-red-600"> 
                  <span class="text-red-600 font-medium">‚úó Fail</span>
                </label>
                <label class="flex items-center cursor-pointer mobile-radio-option sm:mobile-radio-option-reset">
                  <input type="radio" name="q-${sIdx}-${i}" value="N/A" class="mr-2 text-gray-600"> 
                  <span class="text-gray-600 font-medium">‚òê N/A</span>
                </label>
              </div>
              <textarea name="notes-${sIdx}-${i}" placeholder="Notes (optional)" rows="2"
                        class="w-full border border-gray-300 px-3 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mobile-textarea"
                        onfocus="handleMobileKeyboard(this)" onblur="handleMobileKeyboardHide(this)"></textarea>
            </div>
          `).join('')}
          </div>
        `;
        container.appendChild(sectionEl);
      });
    }

    // Initialize signature pad
    function initSignaturePad() {
      const canvas = document.getElementById('signaturePad');
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)',
        penColor: 'rgb(0, 0, 0)'
      });

      // Resize canvas
      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
      }
      
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      document.getElementById('clearSignature').addEventListener('click', () => {
        signaturePad.clear();
      });
    }

    // Handle signature type selection
    document.addEventListener('change', function(e) {
      if (e.target.name === 'signatureType') {
        const signaturePadContainer = document.getElementById('signaturePadContainer');
        if (e.target.value === 'digital') {
          signaturePadContainer.classList.remove('hidden');
          if (!signaturePad) {
            setTimeout(initSignaturePad, 100);
          }
        } else {
          signaturePadContainer.classList.add('hidden');
        }
      }
    });

    const form = document.getElementById("inspectionForm");
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submitBtn");
      const statusEl = document.getElementById("formStatus");
      const originalBtnText = submitBtn.textContent;
      
      // Check signature requirements
      const signatureType = document.querySelector('input[name="signatureType"]:checked');
      if (!signatureType) {
        alert('Please select a signature method and complete your certification.');
        return;
      }

      if (signatureType.value === 'digital' && signaturePad && signaturePad.isEmpty()) {
        alert('Please provide your digital signature.');
        return;
      }

      // Collect all form data including dynamic questions
      const formData = new FormData(form);
      
      // Build SFPV ID with proper formatting
      const sfpvNumber = formData.get('sfpvNumber')?.trim();
      const paddedSFPVNumber = padSFPVNumber(sfpvNumber);
      const fullSFPVId = `SFPV-${paddedSFPVNumber}`;
      
      // Build VIN with prefix
      const vinNumber = formData.get('vinNumber')?.trim();
      const fullVIN = vinNumber ? `VIN${vinNumber}` : '';

      console.log('Form submission data:', {
        sfpvNumber,
        paddedSFPVNumber,
        fullSFPVId,
        vinNumber,
        fullVIN
      });

      const data = {
        timestamp: new Date().toISOString(),
        sfpvId: fullSFPVId,
        rego: formData.get('rego')?.trim(),
        vin: fullVIN,
        vehicleType: formData.get('vehicleType'),
        inspectorEmail: formData.get('inspectorEmail')?.trim(),
        inspectionDate: formData.get('inspectionDate'),
        outcome: formData.get('outcome'),
        comments: formData.get('comments')?.trim(),
        ailName: formData.get('ailName')?.trim(),
        signatureType: signatureType.value,
        signatureData: signatureType.value === 'digital' && signaturePad ? signaturePad.toDataURL() : null,
        inspectionDetails: {},
        documents: []
      };

      // Collect inspection questions and notes
      for (let [key, value] of formData.entries()) {
        if (key.startsWith('q-') || key.startsWith('notes-')) {
          data.inspectionDetails[key] = value;
        }
      }

      // Process uploaded files
      if (uploadedFiles.length > 0) {
        statusEl.textContent = "Processing uploaded files...";
        statusEl.className = "text-sm mt-4 text-center text-blue-600";
        
        for (let file of uploadedFiles) {
          try {
            const base64Data = await fileToBase64(file);
            data.documents.push({
              name: file.name,
              type: file.type,
              size: file.size,
              data: base64Data
            });
          } catch (error) {
            console.error('Error processing file:', file.name, error);
            alert(`Error processing file: ${file.name}`);
            return;
          }
        }
      }

      // Show loading state
      submitBtn.textContent = "Submitting...";
      submitBtn.disabled = true;
      statusEl.textContent = "Submitting inspection...";
      statusEl.className = "text-sm mt-4 text-center text-blue-600";

      try {
        // Method 1: Try direct fetch to updated Google Apps Script
        console.log('Submitting inspection data:', JSON.stringify(data, null, 2));
        
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbw4Cht9-kkgXjEdbiR1zA-V-8L83zLPMGgQpQKlER2296_kizjG_WpS36wzy715sEmJ/exec",
          {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          }
        );

        console.log('Fetch completed - no-cors mode');
        
        // With no-cors, we can't read the response, so assume success
        statusEl.textContent = `‚úÖ Inspection submitted successfully! Vehicle ${fullSFPVId} record updated in spreadsheet.`;
        statusEl.className = "text-sm mt-4 text-center text-green-600 font-semibold";
        
        // Show download/print options
        showSuccessOptions(data, fullSFPVId);
        
        // Reset form
        form.reset();
        uploadedFiles = [];
        updateFileList();
        if (signaturePad) signaturePad.clear();
        document.getElementById('signaturePadContainer').classList.add('hidden');
        
        // Set today's date again after reset
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="inspectionDate"]').value = today;

      } catch (err) {
        console.error("Direct fetch failed, trying form submission:", err);
        
        // Method 2: Form submission fallback with better error handling
        try {
          statusEl.textContent = "Retrying submission with fallback method...";
          statusEl.className = "text-sm mt-4 text-center text-blue-600";
          
          // Create a hidden form and submit it
          const hiddenForm = document.createElement('form');
          hiddenForm.method = 'POST';
          hiddenForm.action = 'https://script.google.com/macros/s/AKfycbw4Cht9-kkgXjEdbiR1zA-V-8L83zLPMGgQpQKlER2296_kizjG_WpS36wzy715sEmJ/exec';
          hiddenForm.target = '_blank'; // Open in new tab so user can see result
          hiddenForm.style.display = 'none';
          
          // Add all data as hidden form fields
          Object.keys(data).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = typeof data[key] === 'object' ? JSON.stringify(data[key]) : data[key];
            hiddenForm.appendChild(input);
          });
          
          document.body.appendChild(hiddenForm);
          hiddenForm.submit();
          document.body.removeChild(hiddenForm);
          
          statusEl.textContent = `‚úÖ Inspection submitted via fallback method! Check the new tab for confirmation. Vehicle ${fullSFPVId} should be updated in spreadsheet.`;
          statusEl.className = "text-sm mt-4 text-center text-green-600 font-semibold";
          
          // Show download/print options
          showSuccessOptions(data, fullSFPVId);
          
          // Reset form
          form.reset();
          uploadedFiles = [];
          updateFileList();
          if (signaturePad) signaturePad.clear();
          document.getElementById('signaturePadContainer').classList.add('hidden');
          const today = new Date().toISOString().split('T')[0];
          document.querySelector('input[name="inspectionDate"]').value = today;
          
        } catch (formErr) {
          console.error("Form submission also failed:", formErr);
          statusEl.textContent = "‚ùå Submission failed. Please check your internet connection and try again. If the problem persists, contact support.";
          statusEl.className = "text-sm mt-4 text-center text-red-600";
        }
      } finally {
        // Reset button
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
      }
    });

    // Set today's date as default
    window.addEventListener('load', function() {
      const today = new Date().toISOString().split('T')[0];
      const dateInput = document.querySelector('input[name="inspectionDate"]');
      if (dateInput && !dateInput.value) {
        dateInput.value = today;
      }
    });

    // Function to show success options (download/print)
    function showSuccessOptions(data, sfpvId) {
      const statusEl = document.getElementById("formStatus");
      
      // Create success options HTML
      const optionsHtml = `
        <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
          <div class="flex items-center mb-3">
            <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-green-800 font-semibold">Inspection Successfully Submitted!</span>
          </div>
          <p class="text-green-700 text-sm mb-4">
            ‚úâÔ∏è An email confirmation has been sent to your registered address.<br>
            üìä Vehicle ${sfpvId} has been updated in the database.
          </p>
          <div class="flex flex-wrap gap-3">
            <button onclick="downloadInspectionReport()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
              üìÑ Download Report
            </button>
            <button onclick="printInspectionReport()" 
                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
              üñ®Ô∏è Print Report
            </button>
            <button onclick="emailCopyToSelf()" 
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
              üìß Email Copy
            </button>
          </div>
        </div>
      `;
      
      // Add options after the status message
      statusEl.insertAdjacentHTML('afterend', optionsHtml);
      
      // Store data for later use
      window.lastInspectionData = data;
    }

    // Function to create inspection report HTML
    function createInspectionReportHTML(data) {
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>SFP Inspection - ${data.sfpvId}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
            .header { background: #1e40af; color: white; padding: 20px; text-align: center; position: relative; }
            .success-badge { position: absolute; top: 10px; right: 20px; background: #16a34a; 
                           color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; 
                           font-weight: bold; }
            .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
            .vehicle-info { background: #f0f9ff; }
            .inspection-details { background: #f9fafb; }
            .questions { background: #fefefe; }
            table { width: 100%; border-collapse: collapse; }
            th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
            th { background: #f3f4f6; font-weight: bold; }
            .pass { color: #16a34a; font-weight: bold; }
            .fail { color: #dc2626; font-weight: bold; }
            .na { color: #6b7280; }
            @media print {
              .no-print { display: none; }
              body { margin: 0; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="success-badge">‚úì SUCCESSFULLY SUBMITTED</div>
            <h1>SAFE FREIGHT PROGRAM</h1>
            <h2>Vehicle Inspection Report</h2>
          </div>
          
          <div class="section vehicle-info">
            <h3>Vehicle Information</h3>
            <table>
              <tr><th>SFPV ID</th><td>${data.sfpvId}</td></tr>
              <tr><th>Registration</th><td>${data.rego || 'N/A'}</td></tr>
              <tr><th>VIN</th><td>${data.vin || 'N/A'}</td></tr>
              <tr><th>Vehicle Type</th><td>${data.vehicleType || 'N/A'}</td></tr>
            </table>
          </div>
          
          <div class="section inspection-details">
            <h3>Inspection Details</h3>
            <table>
              <tr><th>Inspection Date</th><td>${data.inspectionDate}</td></tr>
              <tr><th>Inspector Email</th><td>${data.inspectorEmail}</td></tr>
              <tr><th>AIL Name</th><td>${data.ailName || 'N/A'}</td></tr>
              <tr><th>Outcome</th><td><span class="${data.outcome === 'Pass' ? 'pass' : 'fail'}">${data.outcome}</span></td></tr>
              <tr><th>Comments</th><td>${data.comments || 'None'}</td></tr>
              <tr><th>Signature Type</th><td>${data.signatureType || 'N/A'}</td></tr>
              <tr><th>Submitted</th><td>${new Date().toLocaleString()}</td></tr>
            </table>
          </div>
          
          ${Object.keys(data.inspectionDetails || {}).length > 0 ? `
          <div class="section questions">
            <h3>Detailed Inspection Results</h3>
            <table>
              <tr><th>Question</th><th>Result</th><th>Notes</th></tr>
              ${Object.keys(data.inspectionDetails)
                .filter(key => key.startsWith('q-'))
                .sort()
                .map(qKey => {
                  const notesKey = qKey.replace('q-', 'notes-');
                  const result = data.inspectionDetails[qKey];
                  const resultClass = result === 'Pass' ? 'pass' : (result === 'Fail' ? 'fail' : 'na');
                  return `
                    <tr>
                      <td>${qKey}</td>
                      <td><span class="${resultClass}">${result}</span></td>
                      <td>${data.inspectionDetails[notesKey] || ''}</td>
                    </tr>
                  `;
                }).join('')}
            </table>
          </div>
          ` : ''}
          
          <div class="section">
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><em>This report was automatically generated by the Safe Freight Program system.</em></p>
          </div>
        
<script type="module">
  import { guardPage } from "/js/role-gate.js";
  guardPage(["inspector", "ail_manager", "admin"]);
</script>

</body>
    <script type="module" src="/js/sfp-auth-guard.js" data-requires-role="inspector,admin"></script>

        </html>
      `;
      return html;
    }

    // Function to download inspection report
    function downloadInspectionReport() {
      if (!window.lastInspectionData) {
        alert('No inspection data available for download.');
        return;
      }
      
      const html = createInspectionReportHTML(window.lastInspectionData);
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `SFP_Inspection_${window.lastInspectionData.sfpvId}_${window.lastInspectionData.inspectionDate}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Function to print inspection report
    function printInspectionReport() {
      if (!window.lastInspectionData) {
        alert('No inspection data available for printing.');
        return;
      }
      
      const html = createInspectionReportHTML(window.lastInspectionData);
      const printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
      
      // Wait for content to load then print
      printWindow.onload = function() {
        printWindow.print();
        // Close window after printing
        printWindow.onafterprint = function() {
          printWindow.close();
        };
      };
    }

    // Function to email copy to self
    function emailCopyToSelf() {
      if (!window.lastInspectionData) {
        alert('No inspection data available.');
        return;
      }
      
      const data = window.lastInspectionData;
      const subject = `SFP Inspection Report - ${data.sfpvId}`;
      const body = `Dear Inspector,

This is a copy of your completed Safe Freight Program inspection:

Vehicle ID: ${data.sfpvId}
Registration: ${data.rego || 'N/A'}
Inspection Date: ${data.inspectionDate}
Outcome: ${data.outcome}
AIL: ${data.ailName || 'N/A'}

The detailed report has been saved to your system and an email confirmation has been sent.

Thank you for maintaining safety standards.

Safe Freight Program
Generated: ${new Date().toLocaleString()}`;

      const mailtoLink = `mailto:${data.inspectorEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailtoLink);
    }
  </script>
<!-- Mount points for shared fragments -->
<div id="header-placeholder"></div>
<!-- ‚Ä¶ your page content ‚Ä¶ -->
<div id="footer-placeholder"></div>
<!-- Global scripts (keep these in the page, NOT inside header.html) -->
<script src="/js/sfp-auth.js" type="module"></script>
<script src="/js/sfp-api.js" type="module"></script>
<script src="/js/sfp-gas-fetch-patch.js"></script>
<script src="/js/sfp-config.js"></script> <!-- sets SFP_GAS_BASE + SFP_ROLES_URL -->
<script defer="" src="/js/load-header-footer.js"></script>
<script defer="" src="/js/account-indicator.js"></script> <!-- your existing file -->
<script defer="" src="/js/role-guards.js"></script>
<script defer="" src="/js/menu-enhance.js"></script>
<script type="module">import { guardPage } from "/js/role-gate.js";</script>
<script type="module">
  import { guardPage } from "/js/role-gate.js";
  guardPage(["inspector", "ail_manager", "admin"]);
</script>

</body>
</html>
